<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AV放送立願表</title>
    <!-- 引用函式庫 -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 全新設計的 CSS -->
    <style>
        /* --- 全局主題與變數 --- */
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --secondary-color: #6c757d;
            --secondary-hover: #5a6268;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
        }

        /* --- 基礎樣式 --- */
        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 15px;
            line-height: 1.6;
        }
        
        /* --- 標題與頁尾 --- */
        .page-header {
            text-align: center;
            margin-bottom: 25px;
        }
        .page-header h1 {
            font-size: 2.5rem;
            color: var(--text-color);
            font-weight: 700;
        }
        .header-icon {
            font-size: 2.2rem;
            margin-right: 10px;
            vertical-align: middle;
        }
        .page-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            color: var(--secondary-color);
            font-size: 0.9em;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        h2, h3, h4 { color: var(--text-color); }
        hr { border: none; border-top: 1px solid #e9ecef; margin: 2rem 0; }
        
        /* --- 酷炫載入動畫 --- */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            gap: 15px; transition: opacity 0.3s ease;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(0, 123, 255, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- 頁籤樣式 --- */
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 25px; }
        .tab-button {
            padding: 12px 20px; cursor: pointer; border: none; background: none;
            font-size: 16px; font-weight: 500; color: var(--secondary-color);
            border-bottom: 3px solid transparent; transition: all 0.3s;
            display: flex; align-items: center; gap: 8px;
        }
        .tab-button:hover { color: var(--primary-color); background-color: #f8f9fa; }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }
        .tab-content { display: none; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- 表單與按鈕 --- */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select {
            width: 100%; padding: 10px 12px; box-sizing: border-box;
            border: 1px solid #ced4da; border-radius: var(--border-radius);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        }
        .btn {
            padding: 10px 20px; font-size: 16px; font-weight: 500;
            border-radius: var(--border-radius); border: none; cursor: pointer; color: white;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:active { transform: translateY(0); }
        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: var(--danger-hover); }

        /* --- 表格樣式 --- */
        .table-responsive { overflow-x: auto; }
        #my-signups-result table {
            width: 100%; border-collapse: collapse; margin-top: 1.5rem;
        }
        #my-signups-result th, #my-signups-result td {
            border-bottom: 1px solid var(--border-color); padding: 12px 15px; text-align: left;
        }
        #my-signups-result th { background-color: #f8f9fa; font-weight: 600; }
        #my-signups-result tr:hover { background-color: #f1f3f5; }

        /* --- FullCalendar 樣式微調 --- */
        .fc .fc-button-primary {
            background-color: var(--primary-color); border-color: var(--primary-color);
        }
        .fc .fc-button-primary:hover {
            background-color: var(--primary-hover); border-color: var(--primary-hover);
        }

        /* --- 手機瀏覽 CSS (響應式設計) --- */
        @media (max-width: 768px) {
            body { padding: 5px; }
            .page-header h1 { font-size: 1.8rem; }
            .header-icon { font-size: 1.6rem; }
            .container { padding: 15px; }
            .tabs { font-size: 14px; overflow-x: auto; white-space: nowrap; }
            .tab-button { padding: 10px 12px; font-size: 15px; }
            .fc .fc-toolbar { flex-direction: column; gap: 10px; }
            .fc .fc-toolbar-chunk { display: flex; justify-content: space-around; width: 100%; }
        }
    </style>
</head>
<body>
    
    <header class="page-header">
        <h1><span class="header-icon">📡</span>AV放送立願表</h1>
    </header>

    <div class="container">
        <!-- 分頁按鈕 -->
        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'calendar-tab')">
                <span class="tab-icon">📅</span>活動行事曆
            </button>
            <button class="tab-button" onclick="openTab(event, 'my-signups-tab')">
                <span class="tab-icon">👤</span>我的報名
            </button>
            <button class="tab-button" onclick="openTab(event, 'stats-tab')">
                <span class="tab-icon">📊</span>統計報表
            </button>
            <button class="tab-button" onclick="openTab(event, 'admin-tab')">
                <span class="tab-icon">⚙️</span>管理工具
            </button>
        </div>

        <!-- 1. 活動行事曆 -->
        <div id="calendar-tab" class="tab-content active">
            <div id="calendar"></div>
        </div>

        <!-- 2. 我的報名 -->
        <div id="my-signups-tab" class="tab-content">
            <h2>查詢我的報名紀錄</h2>
            <div class="form-group">
                <label for="my-name-input">您的姓名</label>
                <input type="text" id="my-name-input" placeholder="請輸入您報名時使用的姓名">
            </div>
            <button id="search-my-signups" class="btn btn-primary">查詢</button>
            <div id="my-signups-result" class="table-responsive"></div>
        </div>

        <!-- 3. 統計報表 -->
        <div id="stats-tab" class="tab-content">
            <h2>統計報表</h2>
            <div class="form-group">
                <label for="stats-start-date">開始日期</label>
                <input type="date" id="stats-start-date">
            </div>
            <div class="form-group">
                <label for="stats-end-date">結束日期</label>
                <input type="date" id="stats-end-date">
            </div>
            <button id="generate-stats" class="btn btn-primary">產生報表</button>
            <div style="margin-top: 20px; position: relative; height:40vh;">
                <canvas id="stats-chart"></canvas>
            </div>
            <div id="stats-details"></div>
        </div>
        
        <!-- 4. 管理工具 -->
        <div id="admin-tab" class="tab-content">
            <h2>管理工具</h2>
            <p>此處的功能主要用於匯出資料或系統維護。</p>
            <hr>
            <h4>匯出 Excel 報表</h4>
            <div class="form-group">
                <label for="export-start-date">開始日期 (留空為所有)</label>
                <input type="date" id="export-start-date">
            </div>
            <div class="form-group">
                <label for="export-end-date">結束日期 (留空為所有)</label>
                <input type="date" id="export-end-date">
            </div>
            <button id="export-excel-btn" class="btn btn-primary">產生並下載 Excel</button>
            <hr>
            <h4>郵寄報表</h4>
            <div class="form-group">
                <label for="email-start-date">開始日期 (留空為所有)</label>
                <input type="date" id="email-start-date">
            </div>
             <div class="form-group">
                <label for="email-end-date">結束日期 (留空為所有)</label>
                <input type="date" id="email-end-date">
            </div>
            <div class="form-group">
                <label for="recipient-email">收件人 Email</label>
                <input type="email" id="recipient-email" placeholder="請輸入完整的 Email 地址">
            </div>
            <button id="email-report-btn" class="btn btn-primary">產生並寄送報表</button>
            <hr>
            <h4>系統維護</h4>
            <button id="delete-temp-sheets-btn" class="btn btn-danger">清除所有暫存報表</button>
            <p><small>此動作會刪除伺服器上所有已產生的報表連結，以釋放資源。</small></p>
        </div>
    </div>
    
    <footer class="page-footer">
        <p>&copy; 2025 AV-Broadcasting Team. All Rights Reserved. | 版本號: <span id="version-number"></span></p>
    </footer>

    <!-- 載入動畫的 HTML 結構 -->
    <div id="loading" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p id="loading-text">正在處理中...</p>
    </div>

    <script>
        // --- 後端 API 網址 (無需修改) ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz1dCHAzjMNklN96jXKpWYcTv-NvzKoB8J6CcY30L55dAtaAf0bTRWTJTc20Fk2MZbgeQ/exec";
        
        // --- 所有 JavaScript 邏輯 (完全無需修改) ---
        let calendar;
        let statsChart = null;
        let currentUserName = localStorage.getItem('av_signup_username') || '';

        function showLoading(text = '正在處理中...') {
            document.getElementById('loading-text').innerText = text;
            document.getElementById('loading').style.display = 'flex';
        }
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function callAppsScript(functionName, params = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonpCallback_' + new Date().getTime() + Math.floor(Math.random() * 1000);
                
                window[callbackName] = (response) => {
                    if (response.status === 'success') {
                        resolve(response.data);
                    } else {
                        console.error('後端錯誤:', response.message);
                        reject(new Error(response.message || '發生未知後端錯誤。'));
                    }
                    delete window[callbackName];
                    document.body.removeChild(document.getElementById(callbackName));
                };

                const payload = { functionName, params };
                const url = `${SCRIPT_URL}?callback=${callbackName}&payload=${encodeURIComponent(JSON.stringify(payload))}`;
                
                const script = document.createElement('script');
                script.id = callbackName;
                script.src = url;
                script.onerror = () => {
                    console.error('請求後端超時或網路錯誤。');
                    reject(new Error('請求後端伺服器超時。後端可能正在忙碌或執行時間過長。'));
                    delete window[callbackName];
                    document.body.removeChild(script);
                };
                document.body.appendChild(script);
            });
        }

        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        
        async function promptForName() {
            const { value: name } = await Swal.fire({
                title: "請輸入您的姓名",
                input: "text",
                inputValue: currentUserName,
                inputLabel: "報名與查詢時將會使用此姓名",
                inputPlaceholder: "請輸入姓名",
                showCancelButton: true,
                inputValidator: (value) => {
                    if (!value) {
                        return "姓名不能為空！";
                    }
                }
            });
            if (name) {
                currentUserName = name;
                localStorage.setItem('av_signup_username', name);
            }
            return name;
        }

        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'zh-tw',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek'
                },
                initialView: 'dayGridMonth',
                events: function(fetchInfo, successCallback, failureCallback) {
                    showLoading('正在載入活動資料...');
                    callAppsScript('getEventsAndSignups')
                        .then(events => successCallback(events))
                        .catch(error => {
                            Swal.fire('載入失敗', error.message, 'error');
                            failureCallback(error);
                        })
                        .finally(() => hideLoading());
                },
                eventClick: async function(info) {
                    info.jsEvent.preventDefault();
                    
                    if (!currentUserName) {
                        const name = await promptForName();
                        if (!name) return;
                    }
                    
                    const { extendedProps: props } = info.event;
                    const signedUpUsers = props.signups.map(s => s.user);
                    const takenPositions = props.signups.map(s => s.position);
                    const availablePositions = props.positions.filter(p => !takenPositions.includes(p));
                    
                    if (signedUpUsers.includes(currentUserName)) {
                        Swal.fire('提示', '您已經報名過此活動了。', 'info');
                        return;
                    }
                    
                    if (availablePositions.length === 0) {
                        Swal.fire('提示', '所有崗位皆已額滿。', 'warning');
                        return;
                    }
                    
                    const positionOptions = availablePositions.reduce((obj, pos) => {
                        obj[pos] = pos;
                        return obj;
                    }, {});

                    const { value: selectedPosition } = await Swal.fire({
                        title: props.full_title,
                        html: `<b>時間:</b> ${props.startTime}<br><b>說明:</b> ${props.description || '無'}<br><br><b>請選擇您要報名的崗位：</b>`,
                        input: 'select',
                        inputOptions: positionOptions,
                        inputPlaceholder: '選擇崗位',
                        showCancelButton: true,
                        confirmButtonText: '確認報名',
                        cancelButtonText: '取消',
                        preConfirm: (position) => {
                            if (!position) {
                                Swal.showValidationMessage('請選擇一個崗位');
                            }
                            return position;
                        }
                    });

                    if (selectedPosition) {
                        showLoading('正在為您報名...');
                        try {
                            const result = await callAppsScript('addSignup', { eventId: info.event.id, userName: currentUserName, position: selectedPosition });
                            
                            if(result.status === 'success') {
                                Swal.fire('報名成功！', result.message, 'success');
                                calendar.refetchEvents();
                            } else if (result.status === 'confirm_backup') {
                                const backupConfirm = await Swal.fire({
                                    title: '崗位已被報名',
                                    text: result.message,
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonColor: '#3085d6',
                                    cancelButtonColor: '#d33',
                                    confirmButtonText: '是的，報名備援',
                                    cancelButtonText: '取消'
                                });
                                if (backupConfirm.isConfirmed) {
                                    showLoading('正在報名備援...');
                                    const backupResult = await callAppsScript('addBackupSignup', { eventId: info.event.id, userName: currentUserName, position: selectedPosition });
                                    Swal.fire('備援報名成功！', backupResult.message, 'success');
                                    calendar.refetchEvents();
                                }
                            } else {
                                Swal.fire('報名失敗', result.message, 'error');
                            }
                        } catch(error) {
                            Swal.fire('報名失敗', error.message, 'error');
                        } finally {
                            hideLoading();
                        }
                    }
                }
            });
            calendar.render();
        }

        document.getElementById('search-my-signups').addEventListener('click', async () => {
            const userName = document.getElementById('my-name-input').value.trim();
            if (!userName) {
                Swal.fire('提示', '請先輸入您的姓名', 'info');
                return;
            }
            
            showLoading('正在查詢您的報名紀錄...');
            try {
                const signups = await callAppsScript('getMySignups', { userName });
                const resultDiv = document.getElementById('my-signups-result');
                if (signups.length === 0) {
                    resultDiv.innerHTML = '<p>找不到您的報名紀錄。</p>';
                    return;
                }
                let tableHtml = '<table><thead><tr><th>活動日期</th><th>活動名稱</th><th>崗位</th><th>報名時間</th><th>操作</th></tr></thead><tbody>';
                signups.forEach(s => {
                    tableHtml += `<tr>
                        <td>${s.eventDate}</td>
                        <td>${s.eventTitle}</td>
                        <td>${s.position}</td>
                        <td>${s.timestamp}</td>
                        <td><button class="btn btn-danger" onclick="removeSignup('${s.eventId}', '${s.user}')">取消</button></td>
                    </tr>`;
                });
                tableHtml += '</tbody></table>';
                resultDiv.innerHTML = tableHtml;

            } catch(error) {
                Swal.fire('查詢失敗', error.message, 'error');
            } finally {
                hideLoading();
            }
        });
        
        async function removeSignup(eventId, userName) {
            const confirmResult = await Swal.fire({
                title: '確定要取消報名嗎？',
                text: "此操作無法復原！",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '是的，取消它！',
                cancelButtonText: '不，保留它'
            });

            if (confirmResult.isConfirmed) {
                showLoading('正在為您取消報名...');
                try {
                    const result = await callAppsScript('removeSignup', { eventId, userName });
                    Swal.fire('操作成功', result.message, 'success');
                    document.getElementById('search-my-signups').click();
                } catch(error) {
                    Swal.fire('操作失敗', error.message, 'error');
                } finally {
                    hideLoading();
                }
            }
        }
        
        document.getElementById('generate-stats').addEventListener('click', async () => {
            const startDateStr = document.getElementById('stats-start-date').value;
            const endDateStr = document.getElementById('stats-end-date').value;
            
            showLoading('正在產生統計資料...');
            try {
                const statsData = await callAppsScript('getStatsData', { startDateStr, endDateStr });
                const ctx = document.getElementById('stats-chart').getContext('2d');
                if (statsChart) {
                    statsChart.destroy();
                }
                if (statsData.labels.length === 0) {
                    Swal.fire('提示', '在選定的日期範圍內沒有任何報名記錄。', 'info');
                    document.getElementById('stats-details').innerHTML = '';
                    return;
                }
                statsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: statsData.labels,
                        datasets: [{
                            label: '報名人數',
                            data: statsData.data,
                            backgroundColor: 'rgba(0, 123, 255, 0.6)',
                            borderColor: 'rgba(0, 123, 255, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                let detailsHtml = '<h3>詳細報名名單</h3>';
                statsData.fullDetails.forEach(detail => {
                    detailsHtml += `<h4>${detail.eventInfo.title} (${detail.eventInfo.date})</h4><ul>`;
                    detail.signups.forEach(signup => {
                        detailsHtml += `<li>${signup.position}: ${signup.user}</li>`;
                    });
                    detailsHtml += `</ul>`;
                });
                document.getElementById('stats-details').innerHTML = detailsHtml;

            } catch(error) {
                Swal.fire('產生失敗', error.message, 'error');
            } finally {
                hideLoading();
            }
        });
        
        document.getElementById('export-excel-btn').addEventListener('click', async () => {
            const startDateStr = document.getElementById('export-start-date').value;
            const endDateStr = document.getElementById('export-end-date').value;
            showLoading('正在產生匯出連結...');
            try {
                const result = await callAppsScript('createTempSheetAndExport', { startDateStr, endDateStr });
                if (result.status === 'nodata') {
                     Swal.fire('提示', result.message, 'info');
                     return;
                }
                Swal.fire({
                    title: '匯出連結已產生',
                    html: '您的 Excel 報表已準備就緒。<br>此連結將在 24 小時後失效。',
                    icon: 'success',
                    showCancelButton: true,
                    confirmButtonText: '點此下載',
                }).then((res) => {
                    if (res.isConfirmed) {
                        window.open(result.url, '_blank');
                        callAppsScript('scheduleDeletion', { sheetName: result.sheetName });
                    }
                });
            } catch(error) {
                Swal.fire('匯出失敗', error.message, 'error');
            } finally {
                hideLoading();
            }
        });
        
        document.getElementById('email-report-btn').addEventListener('click', async () => {
            const startDateStr = document.getElementById('email-start-date').value;
            const endDateStr = document.getElementById('email-end-date').value;
            const recipientEmail = document.getElementById('recipient-email').value.trim();
            if (!recipientEmail) {
                Swal.fire('錯誤', '請輸入收件人 Email 地址。', 'error');
                return;
            }
            showLoading('正在產生並郵寄報表...');
            try {
                const result = await callAppsScript('exportAndEmailReport', { startDateStr, endDateStr, recipientEmail });
                if (result.status === 'nodata') {
                     Swal.fire('提示', result.message, 'info');
                } else {
                     Swal.fire('寄送成功', result.message, 'success');
                }
            } catch(error) {
                Swal.fire('寄送失敗', error.message, 'error');
            } finally {
                hideLoading();
            }
        });
        
        document.getElementById('delete-temp-sheets-btn').addEventListener('click', async () => {
             const confirmResult = await Swal.fire({
                title: '確定要清除所有暫存報表嗎？',
                text: "這會刪除所有已產生的報表連結，此操作無法復原！",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '是的，清除它！'
            });
            if (confirmResult.isConfirmed) {
                showLoading('正在清除中...');
                try {
                    const result = await callAppsScript('deleteAllTempSheets');
                    Swal.fire('操作完成', result.message, result.status === 'success' ? 'success' : 'info');
                } catch(error) {
                    Swal.fire('清除失敗', error.message, 'error');
                } finally {
                    hideLoading();
                }
            }
        });

        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', function() {
            // 設定姓名輸入框的預設值
            if (currentUserName) {
                document.getElementById('my-name-input').value = currentUserName;
            }
            // 載入日曆
            initializeCalendar();
            // 設定頁尾版本號
            const today = new Date();
            const versionDate = today.toISOString().slice(0, 10); // 格式為 YYYY-MM-DD
            document.getElementById('version-number').textContent = versionDate;
        });
    </script>
</body>
</html>