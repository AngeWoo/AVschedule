<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVæ”¾é€ç«‹é¡˜è¡¨</title>
    <!-- å¼•ç”¨å‡½å¼åº« -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- å…¨æ–°è¨­è¨ˆçš„ CSS -->
    <style>
        /* --- å…¨å±€ä¸»é¡Œèˆ‡è®Šæ•¸ --- */
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --secondary-color: #6c757d;
            --secondary-hover: #5a6268;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
        }

        /* --- åŸºç¤æ¨£å¼ --- */
        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 15px;
            line-height: 1.6;
        }
        
        /* --- æ¨™é¡Œèˆ‡é å°¾ --- */
        .page-header {
            text-align: center;
            margin-bottom: 25px;
        }
        .page-header h1 {
            font-size: 2.5rem;
            color: var(--text-color);
            font-weight: 700;
        }
        .header-icon {
            font-size: 2.2rem;
            margin-right: 10px;
            vertical-align: middle;
        }
        .page-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            color: var(--secondary-color);
            font-size: 0.9em;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        h2, h3, h4 { color: var(--text-color); }
        hr { border: none; border-top: 1px solid #e9ecef; margin: 2rem 0; }
        
        /* --- é…·ç‚«è¼‰å…¥å‹•ç•« --- */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            gap: 15px; transition: opacity 0.3s ease;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(0, 123, 255, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- é ç±¤æ¨£å¼ --- */
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 25px; }
        .tab-button {
            padding: 12px 20px; cursor: pointer; border: none; background: none;
            font-size: 16px; font-weight: 500; color: var(--secondary-color);
            border-bottom: 3px solid transparent; transition: all 0.3s;
            display: flex; align-items: center; gap: 8px;
        }
        .tab-button:hover { color: var(--primary-color); background-color: #f8f9fa; }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }
        .tab-content { display: none; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- è¡¨å–®èˆ‡æŒ‰éˆ• --- */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select {
            width: 100%; padding: 10px 12px; box-sizing: border-box;
            border: 1px solid #ced4da; border-radius: var(--border-radius);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        }
        .btn {
            padding: 10px 20px; font-size: 16px; font-weight: 500;
            border-radius: var(--border-radius); border: none; cursor: pointer; color: white;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:active { transform: translateY(0); }
        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: var(--danger-hover); }

        /* --- è¡¨æ ¼æ¨£å¼ --- */
        .table-responsive { overflow-x: auto; }
        #my-signups-result table {
            width: 100%; border-collapse: collapse; margin-top: 1.5rem;
        }
        #my-signups-result th, #my-signups-result td {
            border-bottom: 1px solid var(--border-color); padding: 12px 15px; text-align: left;
        }
        #my-signups-result th { background-color: #f8f9fa; font-weight: 600; }
        #my-signups-result tr:hover { background-color: #f1f3f5; }

        /* --- FullCalendar æ¨£å¼å¾®èª¿ --- */
        .fc .fc-button-primary {
            background-color: var(--primary-color); border-color: var(--primary-color);
        }
        .fc .fc-button-primary:hover {
            background-color: var(--primary-hover); border-color: var(--primary-hover);
        }

        /* --- æ‰‹æ©Ÿç€è¦½ CSS (éŸ¿æ‡‰å¼è¨­è¨ˆ) --- */
        @media (max-width: 768px) {
            body { padding: 5px; }
            .page-header h1 { font-size: 1.8rem; }
            .header-icon { font-size: 1.6rem; }
            .container { padding: 15px; }
            .tabs { font-size: 14px; overflow-x: auto; white-space: nowrap; }
            .tab-button { padding: 10px 12px; font-size: 15px; }
            .fc .fc-toolbar { flex-direction: column; gap: 10px; }
            .fc .fc-toolbar-chunk { display: flex; justify-content: space-around; width: 100%; }
        }
    </style>
</head>
<body>
    
    <header class="page-header">
        <h1><span class="header-icon">ğŸ“¡</span>AVæ”¾é€ç«‹é¡˜è¡¨</h1>
    </header>

    <div class="container">
        <!-- åˆ†é æŒ‰éˆ• -->
        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'calendar-tab')">
                <span class="tab-icon">ğŸ“…</span>æ´»å‹•è¡Œäº‹æ›†
            </button>
            <button class="tab-button" onclick="openTab(event, 'my-signups-tab')">
                <span class="tab-icon">ğŸ‘¤</span>æˆ‘çš„å ±å
            </button>
            <button class="tab-button" onclick="openTab(event, 'stats-tab')">
                <span class="tab-icon">ğŸ“Š</span>çµ±è¨ˆå ±è¡¨
            </button>
            <button class="tab-button" onclick="openTab(event, 'admin-tab')">
                <span class="tab-icon">âš™ï¸</span>ç®¡ç†å·¥å…·
            </button>
        </div>

        <!-- 1. æ´»å‹•è¡Œäº‹æ›† -->
        <div id="calendar-tab" class="tab-content active">
            <div id="calendar"></div>
        </div>

        <!-- 2. æˆ‘çš„å ±å -->
        <div id="my-signups-tab" class="tab-content">
            <h2>æŸ¥è©¢æˆ‘çš„å ±åç´€éŒ„</h2>
            <div class="form-group">
                <label for="my-name-input">æ‚¨çš„å§“å</label>
                <input type="text" id="my-name-input" placeholder="è«‹è¼¸å…¥æ‚¨å ±åæ™‚ä½¿ç”¨çš„å§“å">
            </div>
            <button id="search-my-signups" class="btn btn-primary">æŸ¥è©¢</button>
            <div id="my-signups-result" class="table-responsive"></div>
        </div>

        <!-- 3. çµ±è¨ˆå ±è¡¨ -->
        <div id="stats-tab" class="tab-content">
            <h2>çµ±è¨ˆå ±è¡¨</h2>
            <div class="form-group">
                <label for="stats-start-date">é–‹å§‹æ—¥æœŸ</label>
                <input type="date" id="stats-start-date">
            </div>
            <div class="form-group">
                <label for="stats-end-date">çµæŸæ—¥æœŸ</label>
                <input type="date" id="stats-end-date">
            </div>
            <button id="generate-stats" class="btn btn-primary">ç”¢ç”Ÿå ±è¡¨</button>
            <div style="margin-top: 20px; position: relative; height:40vh;">
                <canvas id="stats-chart"></canvas>
            </div>
            <div id="stats-details"></div>
        </div>
        
        <!-- 4. ç®¡ç†å·¥å…· -->
        <div id="admin-tab" class="tab-content">
            <h2>ç®¡ç†å·¥å…·</h2>
            <p>æ­¤è™•çš„åŠŸèƒ½ä¸»è¦ç”¨æ–¼åŒ¯å‡ºè³‡æ–™æˆ–ç³»çµ±ç¶­è­·ã€‚</p>
            <hr>
            <h4>åŒ¯å‡º Excel å ±è¡¨</h4>
            <div class="form-group">
                <label for="export-start-date">é–‹å§‹æ—¥æœŸ (ç•™ç©ºç‚ºæ‰€æœ‰)</label>
                <input type="date" id="export-start-date">
            </div>
            <div class="form-group">
                <label for="export-end-date">çµæŸæ—¥æœŸ (ç•™ç©ºç‚ºæ‰€æœ‰)</label>
                <input type="date" id="export-end-date">
            </div>
            <button id="export-excel-btn" class="btn btn-primary">ç”¢ç”Ÿä¸¦ä¸‹è¼‰ Excel</button>
            <hr>
            <h4>éƒµå¯„å ±è¡¨</h4>
            <div class="form-group">
                <label for="email-start-date">é–‹å§‹æ—¥æœŸ (ç•™ç©ºç‚ºæ‰€æœ‰)</label>
                <input type="date" id="email-start-date">
            </div>
             <div class="form-group">
                <label for="email-end-date">çµæŸæ—¥æœŸ (ç•™ç©ºç‚ºæ‰€æœ‰)</label>
                <input type="date" id="email-end-date">
            </div>
            <div class="form-group">
                <label for="recipient-email">æ”¶ä»¶äºº Email</label>
                <input type="email" id="recipient-email" placeholder="è«‹è¼¸å…¥å®Œæ•´çš„ Email åœ°å€">
            </div>
            <button id="email-report-btn" class="btn btn-primary">ç”¢ç”Ÿä¸¦å¯„é€å ±è¡¨</button>
            <hr>
            <h4>ç³»çµ±ç¶­è­·</h4>
            <button id="delete-temp-sheets-btn" class="btn btn-danger">æ¸…é™¤æ‰€æœ‰æš«å­˜å ±è¡¨</button>
            <p><small>æ­¤å‹•ä½œæœƒåˆªé™¤ä¼ºæœå™¨ä¸Šæ‰€æœ‰å·²ç”¢ç”Ÿçš„å ±è¡¨é€£çµï¼Œä»¥é‡‹æ”¾è³‡æºã€‚</small></p>
        </div>
    </div>
    
    <footer class="page-footer">
        <p>&copy; 2025 AV-Broadcasting Team. All Rights Reserved. | ç‰ˆæœ¬è™Ÿ: <span id="version-number"></span></p>
    </footer>

    <!-- è¼‰å…¥å‹•ç•«çš„ HTML çµæ§‹ -->
    <div id="loading" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p id="loading-text">æ­£åœ¨è™•ç†ä¸­...</p>
    </div>

    <script>
        // --- å¾Œç«¯ API ç¶²å€ (ç„¡éœ€ä¿®æ”¹) ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz1dCHAzjMNklN96jXKpWYcTv-NvzKoB8J6CcY30L55dAtaAf0bTRWTJTc20Fk2MZbgeQ/exec";
        
        // --- æ‰€æœ‰ JavaScript é‚è¼¯ (å®Œå…¨ç„¡éœ€ä¿®æ”¹) ---
        let calendar;
        let statsChart = null;
        let currentUserName = localStorage.getItem('av_signup_username') || '';

        function showLoading(text = 'æ­£åœ¨è™•ç†ä¸­...') {
            document.getElementById('loading-text').innerText = text;
            document.getElementById('loading').style.display = 'flex';
        }
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function callAppsScript(functionName, params = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonpCallback_' + new Date().getTime() + Math.floor(Math.random() * 1000);
                
                window[callbackName] = (response) => {
                    if (response.status === 'success') {
                        resolve(response.data);
                    } else {
                        console.error('å¾Œç«¯éŒ¯èª¤:', response.message);
                        reject(new Error(response.message || 'ç™¼ç”ŸæœªçŸ¥å¾Œç«¯éŒ¯èª¤ã€‚'));
                    }
                    delete window[callbackName];
                    document.body.removeChild(document.getElementById(callbackName));
                };

                const payload = { functionName, params };
                const url = `${SCRIPT_URL}?callback=${callbackName}&payload=${encodeURIComponent(JSON.stringify(payload))}`;
                
                const script = document.createElement('script');
                script.id = callbackName;
                script.src = url;
                script.onerror = () => {
                    console.error('è«‹æ±‚å¾Œç«¯è¶…æ™‚æˆ–ç¶²è·¯éŒ¯èª¤ã€‚');
                    reject(new Error('è«‹æ±‚å¾Œç«¯ä¼ºæœå™¨è¶…æ™‚ã€‚å¾Œç«¯å¯èƒ½æ­£åœ¨å¿™ç¢Œæˆ–åŸ·è¡Œæ™‚é–“éé•·ã€‚'));
                    delete window[callbackName];
                    document.body.removeChild(script);
                };
                document.body.appendChild(script);
            });
        }

        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        
        async function promptForName() {
            const { value: name } = await Swal.fire({
                title: "è«‹è¼¸å…¥æ‚¨çš„å§“å",
                input: "text",
                inputValue: currentUserName,
                inputLabel: "å ±åèˆ‡æŸ¥è©¢æ™‚å°‡æœƒä½¿ç”¨æ­¤å§“å",
                inputPlaceholder: "è«‹è¼¸å…¥å§“å",
                showCancelButton: true,
                inputValidator: (value) => {
                    if (!value) {
                        return "å§“åä¸èƒ½ç‚ºç©ºï¼";
                    }
                }
            });
            if (name) {
                currentUserName = name;
                localStorage.setItem('av_signup_username', name);
            }
            return name;
        }

        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'zh-tw',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek'
                },
                initialView: 'dayGridMonth',
                events: function(fetchInfo, successCallback, failureCallback) {
                    showLoading('æ­£åœ¨è¼‰å…¥æ´»å‹•è³‡æ–™...');
                    callAppsScript('getEventsAndSignups')
                        .then(events => successCallback(events))
                        .catch(error => {
                            Swal.fire('è¼‰å…¥å¤±æ•—', error.message, 'error');
                            failureCallback(error);
                        })
                        .finally(() => hideLoading());
                },
                eventClick: async function(info) {
                    info.jsEvent.preventDefault();
                    
                    if (!currentUserName) {
                        const name = await promptForName();
                        if (!name) return;
                    }
                    
                    const { extendedProps: props } = info.event;
                    const signedUpUsers = props.signups.map(s => s.user);
                    const takenPositions = props.signups.map(s => s.position);
                    const availablePositions = props.positions.filter(p => !takenPositions.includes(p));
                    
                    if (signedUpUsers.includes(currentUserName)) {
                        Swal.fire('æç¤º', 'æ‚¨å·²ç¶“å ±åéæ­¤æ´»å‹•äº†ã€‚', 'info');
                        return;
                    }
                    
                    if (availablePositions.length === 0) {
                        Swal.fire('æç¤º', 'æ‰€æœ‰å´—ä½çš†å·²é¡æ»¿ã€‚', 'warning');
                        return;
                    }
                    
                    const positionOptions = availablePositions.reduce((obj, pos) => {
                        obj[pos] = pos;
                        return obj;
                    }, {});

                    const { value: selectedPosition } = await Swal.fire({
                        title: props.full_title,
                        html: `<b>æ™‚é–“:</b> ${props.startTime}<br><b>èªªæ˜:</b> ${props.description || 'ç„¡'}<br><br><b>è«‹é¸æ“‡æ‚¨è¦å ±åçš„å´—ä½ï¼š</b>`,
                        input: 'select',
                        inputOptions: positionOptions,
                        inputPlaceholder: 'é¸æ“‡å´—ä½',
                        showCancelButton: true,
                        confirmButtonText: 'ç¢ºèªå ±å',
                        cancelButtonText: 'å–æ¶ˆ',
                        preConfirm: (position) => {
                            if (!position) {
                                Swal.showValidationMessage('è«‹é¸æ“‡ä¸€å€‹å´—ä½');
                            }
                            return position;
                        }
                    });

                    if (selectedPosition) {
                        showLoading('æ­£åœ¨ç‚ºæ‚¨å ±å...');
                        try {
                            const result = await callAppsScript('addSignup', { eventId: info.event.id, userName: currentUserName, position: selectedPosition });
                            
                            if(result.status === 'success') {
                                Swal.fire('å ±åæˆåŠŸï¼', result.message, 'success');
                                calendar.refetchEvents();
                            } else if (result.status === 'confirm_backup') {
                                const backupConfirm = await Swal.fire({
                                    title: 'å´—ä½å·²è¢«å ±å',
                                    text: result.message,
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonColor: '#3085d6',
                                    cancelButtonColor: '#d33',
                                    confirmButtonText: 'æ˜¯çš„ï¼Œå ±åå‚™æ´',
                                    cancelButtonText: 'å–æ¶ˆ'
                                });
                                if (backupConfirm.isConfirmed) {
                                    showLoading('æ­£åœ¨å ±åå‚™æ´...');
                                    const backupResult = await callAppsScript('addBackupSignup', { eventId: info.event.id, userName: currentUserName, position: selectedPosition });
                                    Swal.fire('å‚™æ´å ±åæˆåŠŸï¼', backupResult.message, 'success');
                                    calendar.refetchEvents();
                                }
                            } else {
                                Swal.fire('å ±åå¤±æ•—', result.message, 'error');
                            }
                        } catch(error) {
                            Swal.fire('å ±åå¤±æ•—', error.message, 'error');
                        } finally {
                            hideLoading();
                        }
                    }
                }
            });
            calendar.render();
        }

        document.getElementById('search-my-signups').addEventListener('click', async () => {
            const userName = document.getElementById('my-name-input').value.trim();
            if (!userName) {
                Swal.fire('æç¤º', 'è«‹å…ˆè¼¸å…¥æ‚¨çš„å§“å', 'info');
                return;
            }
            
            showLoading('æ­£åœ¨æŸ¥è©¢æ‚¨çš„å ±åç´€éŒ„...');
            try {
                const signups = await callAppsScript('getMySignups', { userName });
                const resultDiv = document.getElementById('my-signups-result');
                if (signups.length === 0) {
                    resultDiv.innerHTML = '<p>æ‰¾ä¸åˆ°æ‚¨çš„å ±åç´€éŒ„ã€‚</p>';
                    return;
                }
                let tableHtml = '<table><thead><tr><th>æ´»å‹•æ—¥æœŸ</th><th>æ´»å‹•åç¨±</th><th>å´—ä½</th><th>å ±åæ™‚é–“</th><th>æ“ä½œ</th></tr></thead><tbody>';
                signups.forEach(s => {
                    tableHtml += `<tr>
                        <td>${s.eventDate}</td>
                        <td>${s.eventTitle}</td>
                        <td>${s.position}</td>
                        <td>${s.timestamp}</td>
                        <td><button class="btn btn-danger" onclick="removeSignup('${s.eventId}', '${s.user}')">å–æ¶ˆ</button></td>
                    </tr>`;
                });
                tableHtml += '</tbody></table>';
                resultDiv.innerHTML = tableHtml;

            } catch(error) {
                Swal.fire('æŸ¥è©¢å¤±æ•—', error.message, 'error');
            } finally {
                hideLoading();
            }
        });
        
        async function removeSignup(eventId, userName) {
            const confirmResult = await Swal.fire({
                title: 'ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿ',
                text: "æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'æ˜¯çš„ï¼Œå–æ¶ˆå®ƒï¼',
                cancelButtonText: 'ä¸ï¼Œä¿ç•™å®ƒ'
            });

            if (confirmResult.isConfirmed) {
                showLoading('æ­£åœ¨ç‚ºæ‚¨å–æ¶ˆå ±å...');
                try {
                    const result = await callAppsScript('removeSignup', { eventId, userName });
                    Swal.fire('æ“ä½œæˆåŠŸ', result.message, 'success');
                    document.getElementById('search-my-signups').click();
                } catch(error) {
                    Swal.fire('æ“ä½œå¤±æ•—', error.message, 'error');
                } finally {
                    hideLoading();
                }
            }
        }
        
        document.getElementById('generate-stats').addEventListener('click', async () => {
            const startDateStr = document.getElementById('stats-start-date').value;
            const endDateStr = document.getElementById('stats-end-date').value;
            
            showLoading('æ­£åœ¨ç”¢ç”Ÿçµ±è¨ˆè³‡æ–™...');
            try {
                const statsData = await callAppsScript('getStatsData', { startDateStr, endDateStr });
                const ctx = document.getElementById('stats-chart').getContext('2d');
                if (statsChart) {
                    statsChart.destroy();
                }
                if (statsData.labels.length === 0) {
                    Swal.fire('æç¤º', 'åœ¨é¸å®šçš„æ—¥æœŸç¯„åœå…§æ²’æœ‰ä»»ä½•å ±åè¨˜éŒ„ã€‚', 'info');
                    document.getElementById('stats-details').innerHTML = '';
                    return;
                }
                statsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: statsData.labels,
                        datasets: [{
                            label: 'å ±åäººæ•¸',
                            data: statsData.data,
                            backgroundColor: 'rgba(0, 123, 255, 0.6)',
                            borderColor: 'rgba(0, 123, 255, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                let detailsHtml = '<h3>è©³ç´°å ±ååå–®</h3>';
                statsData.fullDetails.forEach(detail => {
                    detailsHtml += `<h4>${detail.eventInfo.title} (${detail.eventInfo.date})</h4><ul>`;
                    detail.signups.forEach(signup => {
                        detailsHtml += `<li>${signup.position}: ${signup.user}</li>`;
                    });
                    detailsHtml += `</ul>`;
                });
                document.getElementById('stats-details').innerHTML = detailsHtml;

            } catch(error) {
                Swal.fire('ç”¢ç”Ÿå¤±æ•—', error.message, 'error');
            } finally {
                hideLoading();
            }
        });
        
        document.getElementById('export-excel-btn').addEventListener('click', async () => {
            const startDateStr = document.getElementById('export-start-date').value;
            const endDateStr = document.getElementById('export-end-date').value;
            showLoading('æ­£åœ¨ç”¢ç”ŸåŒ¯å‡ºé€£çµ...');
            try {
                const result = await callAppsScript('createTempSheetAndExport', { startDateStr, endDateStr });
                if (result.status === 'nodata') {
                     Swal.fire('æç¤º', result.message, 'info');
                     return;
                }
                Swal.fire({
                    title: 'åŒ¯å‡ºé€£çµå·²ç”¢ç”Ÿ',
                    html: 'æ‚¨çš„ Excel å ±è¡¨å·²æº–å‚™å°±ç·’ã€‚<br>æ­¤é€£çµå°‡åœ¨ 24 å°æ™‚å¾Œå¤±æ•ˆã€‚',
                    icon: 'success',
                    showCancelButton: true,
                    confirmButtonText: 'é»æ­¤ä¸‹è¼‰',
                }).then((res) => {
                    if (res.isConfirmed) {
                        window.open(result.url, '_blank');
                        callAppsScript('scheduleDeletion', { sheetName: result.sheetName });
                    }
                });
            } catch(error) {
                Swal.fire('åŒ¯å‡ºå¤±æ•—', error.message, 'error');
            } finally {
                hideLoading();
            }
        });
        
        document.getElementById('email-report-btn').addEventListener('click', async () => {
            const startDateStr = document.getElementById('email-start-date').value;
            const endDateStr = document.getElementById('email-end-date').value;
            const recipientEmail = document.getElementById('recipient-email').value.trim();
            if (!recipientEmail) {
                Swal.fire('éŒ¯èª¤', 'è«‹è¼¸å…¥æ”¶ä»¶äºº Email åœ°å€ã€‚', 'error');
                return;
            }
            showLoading('æ­£åœ¨ç”¢ç”Ÿä¸¦éƒµå¯„å ±è¡¨...');
            try {
                const result = await callAppsScript('exportAndEmailReport', { startDateStr, endDateStr, recipientEmail });
                if (result.status === 'nodata') {
                     Swal.fire('æç¤º', result.message, 'info');
                } else {
                     Swal.fire('å¯„é€æˆåŠŸ', result.message, 'success');
                }
            } catch(error) {
                Swal.fire('å¯„é€å¤±æ•—', error.message, 'error');
            } finally {
                hideLoading();
            }
        });
        
        document.getElementById('delete-temp-sheets-btn').addEventListener('click', async () => {
             const confirmResult = await Swal.fire({
                title: 'ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æš«å­˜å ±è¡¨å—ï¼Ÿ',
                text: "é€™æœƒåˆªé™¤æ‰€æœ‰å·²ç”¢ç”Ÿçš„å ±è¡¨é€£çµï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'æ˜¯çš„ï¼Œæ¸…é™¤å®ƒï¼'
            });
            if (confirmResult.isConfirmed) {
                showLoading('æ­£åœ¨æ¸…é™¤ä¸­...');
                try {
                    const result = await callAppsScript('deleteAllTempSheets');
                    Swal.fire('æ“ä½œå®Œæˆ', result.message, result.status === 'success' ? 'success' : 'info');
                } catch(error) {
                    Swal.fire('æ¸…é™¤å¤±æ•—', error.message, 'error');
                } finally {
                    hideLoading();
                }
            }
        });

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', function() {
            // è¨­å®šå§“åè¼¸å…¥æ¡†çš„é è¨­å€¼
            if (currentUserName) {
                document.getElementById('my-name-input').value = currentUserName;
            }
            // è¼‰å…¥æ—¥æ›†
            initializeCalendar();
            // è¨­å®šé å°¾ç‰ˆæœ¬è™Ÿ
            const today = new Date();
            const versionDate = today.toISOString().slice(0, 10); // æ ¼å¼ç‚º YYYY-MM-DD
            document.getElementById('version-number').textContent = versionDate;
        });
    </script>
</body>
</html>