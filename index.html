<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <title>AV放送立願表</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary-color: #1F7AEC; --primary-dark: #0F4CA3; --primary-light: #E8F1FF; --primary-gradient-start: #1F7AEC; --primary-gradient-end: #0F4CA3;
            --accent-color: #F59E0B;
            --bg-color: #F6F7FB; --card-bg-start: #FFFFFF; --card-bg-end: #FBFBFD; --card-border: #E3E7EF; --card-shadow-light: rgba(31, 122, 236, 0.08); --card-shadow-dark: rgba(15, 36, 94, 0.12);
            --text-color: #1F2A44; --text-light: #6B7280; --danger-color: #E74C3C; --danger-dark: #C0392B;
            --border-radius-sm: 10px; --border-radius: 18px; --border-radius-lg: 28px;
            --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); --transition-medium: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Manrope', 'Noto Sans TC', 'Segoe UI', system-ui, -apple-system, sans-serif; background: radial-gradient(circle at 10% 20%, rgba(31,122,236,0.06), transparent 25%), radial-gradient(circle at 90% 0%, rgba(245,158,11,0.08), transparent 22%), var(--bg-color); color: var(--text-color); line-height: 1.7; padding: 24px; display: flex; flex-direction: column; min-height: 100vh; overflow-x: hidden; -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
        body::before { content: ''; position: fixed; inset: 0; background: linear-gradient(135deg, rgba(31,122,236,0.08), transparent 45%), linear-gradient(315deg, rgba(15,76,163,0.06), transparent 55%); z-index: 0; pointer-events: none; }
        .page-header { text-align: center; margin-bottom: 32px; position: relative; z-index: 1; }
        .page-header h1 { font-size: clamp(2rem, 4vw, 3rem); font-weight: 800; color: #fff; letter-spacing: 0.5px; display: inline-flex; justify-content: center; align-items: center; gap: 12px; padding: 14px 26px; background: linear-gradient(120deg, #ff7a7a, #ffb347, #ffe66d, #7ae582, #5ad1e5, #8e7dff, #ff7ac7, #ff7a7a); background-size: 200% 200%; animation: rainbow-shift 12s ease infinite; border: 1px solid rgba(255,255,255,0.35); border-radius: 999px; box-shadow: 0 14px 36px rgba(0,0,0,0.12), 0 8px 18px rgba(0,0,0,0.08); position: relative; overflow: hidden; text-shadow: 0 2px 8px rgba(0,0,0,0.18); }
        .brand-icon { width: 64px; height: 64px; display: inline-flex; align-items: center; justify-content: center; border-radius: 16px; background: rgba(255,255,255,0.16); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; color: #fff; }
        .brand-icon:hover { transform: translateY(-1px) scale(1.02); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.28), 0 6px 12px rgba(0,0,0,0.15); }
        .brand-icon img { width: 44px; height: 44px; object-fit: contain; }
        @keyframes rainbow-shift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        #toggle-marquee-btn { width: 64px; height: 64px; display: inline-flex; align-items: center; justify-content: center; font-size: 36px; cursor: pointer; transition: transform 0.2s ease, color 0.2s ease; user-select: none; padding: 0; border-radius: 16px; background: rgba(0,0,0,0.12); color: #fff; }
        #toggle-marquee-btn:hover { transform: scale(1.02); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.25), 0 4px 8px rgba(0,0,0,0.15); }
        #toggle-marquee-btn.active { color: #fff; background: rgba(0,0,0,0.22); }
        .page-footer { text-align: center; margin-top: auto; padding: 18px 12px; color: var(--text-light); font-size: 0.9em; position: relative; z-index: 1; }
        .container { margin: 0 auto; width: 100%; max-width: 1200px; background: linear-gradient(135deg, var(--card-bg-start), var(--card-bg-end)); padding: 32px; border-radius: var(--border-radius-lg); border: 1px solid var(--card-border); box-shadow: 0 18px 40px var(--card-shadow-dark), 0 8px 18px var(--card-shadow-light); position: relative; z-index: 1; flex-grow: 1; backdrop-filter: blur(6px); }
        h4 { font-size: 1.35rem; font-weight: 700; margin-bottom: 1.25rem; color: var(--text-color); display: flex; align-items: center; gap: 10px; }
        .title-icon { display: inline-flex; align-items: center; justify-content: center; width: 1.3em; height: 1.3em; font-size: 1.1em; margin-right: 6px; }
        h4::before { content: ''; width: 8px; height: 8px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end)); display: inline-block; }
        hr { border: none; height: 1px; background: linear-gradient(90deg, transparent, var(--card-border), transparent); margin: 2rem 0; opacity: 0.9; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.85); z-index: 9999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .loading-overlay::after { content: ''; width: 50px; height: 50px; border: 5px solid var(--primary-light); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .swal2-container { z-index: 10000 !important; }
        .swal2-textarea#clipboard-textarea { width: 95%; margin: 1em auto 0 auto; font-size: 14px; line-height: 1.6; resize: none; font-family: 'Courier New', Courier, monospace; overflow-y: auto; min-height: 150px; max-height: 70vh; }
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 26px; overflow-x: auto; border: 1px solid var(--card-border); position: relative; z-index: 2; background: linear-gradient(145deg, #fff, #f7f8fb); border-radius: 999px; padding: 6px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .tab-button { padding: 14px 18px; cursor: pointer; border: 1px solid var(--card-border); background: var(--card-bg-start); font-size: 1.05rem; font-weight: 700; color: var(--text-light); transition: var(--transition-medium); white-space: nowrap; position: relative; z-index: 1; box-shadow: 0 4px 10px rgba(0,0,0,0.04); border-radius: 14px; margin: 0; min-width: 130px; text-align: center; }
        .tab-button.active { color: #fff; background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end)); border-color: transparent; box-shadow: 0 10px 25px rgba(31,122,236,0.35), 0 0 0 3px rgba(255,255,255,0.65), 0 0 0 6px rgba(31,122,236,0.35); transform: translateY(-1px); }
        .tab-button:not(.active):hover { color: var(--primary-dark); border-color: #d7deeb; box-shadow: 0 8px 20px rgba(31,122,236,0.12); transform: translateY(-2px); }
        .tab-button:active { transform: translateY(0); box-shadow: inset 0 2px 5px rgba(0,0,0,0.08); }
        .tab-button:nth-child(1) { background: linear-gradient(145deg, #2563eb, #1d4ed8); color: #fff; }
        .tab-button:nth-child(2) { background: linear-gradient(145deg, #16a34a, #15803d); color: #fff; }
        .tab-button:nth-child(3) { background: linear-gradient(145deg, #f59e0b, #d97706); color: #fff; }
        .tab-button:nth-child(4) { background: linear-gradient(145deg, #8b5cf6, #7c3aed); color: #fff; }
        .tab-button:nth-child(5) { background: linear-gradient(145deg, #ec4899, #db2777); color: #fff; }
        .tab-button:nth-child(6) { background: linear-gradient(145deg, #06b6d4, #0891b2); color: #fff; }
        .tab-content { display: none; padding-top: 10px; } 
        .tab-content.active { display: block; }
        .inline-form { display: flex; flex-wrap: wrap; align-items: flex-end; gap: 14px; margin-bottom: 22px; background: #f9fafc; border: 1px solid var(--card-border); padding: 14px 16px; border-radius: var(--border-radius); box-shadow: 0 8px 20px rgba(0,0,0,0.03); }
        .inline-form .form-group { flex: 1; margin-bottom: 0; min-width: 160px; }
        .inline-form .form-group-date { flex: 1 0 200px; min-width: 180px; }
        .inline-form .btn { flex-shrink: 0; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 700; color: var(--text-color); font-size: 0.95rem; }
        .form-group input, .form-group select { width: 100%; padding: 12px 14px; border: 1px solid var(--card-border); border-radius: var(--border-radius-sm); background: #fff; font-size: 1rem; color: var(--text-color); box-shadow: inset 0 1px 2px rgba(31,122,236,0.05); transition: var(--transition-fast); }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(31, 122, 236, 0.12); background: #f7faff; }
        .btn { padding: 12px 22px; font-size: 1rem; font-weight: 700; border-radius: 12px; border: none; cursor: pointer; transition: var(--transition-medium); position: relative; overflow: hidden; backface-visibility: hidden; transform: translateZ(0); letter-spacing: 0.2px; }
        .btn-sm { padding: 5px 10px; font-size: 0.875rem; }
        .btn::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.1); z-index: 1; opacity: 0; transform: scale(0.5); border-radius: var(--border-radius-sm); transition: var(--transition-fast); }
        .btn:hover::before { opacity: 1; transform: scale(1); }
        .btn-primary { background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end)); color: white; box-shadow: 0 8px 18px rgba(31, 122, 236, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 12px 26px rgba(31, 122, 236, 0.35); }
        .btn-primary:active { transform: translateY(0); box-shadow: inset 0 3px 8px rgba(0,0,0,0.15); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #b91c1c); color: white; box-shadow: 0 6px 16px rgba(239,68,68,0.3); }
        .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(239,68,68,0.32); }
        .btn-danger:active { transform: translateY(0); box-shadow: inset 0 3px 8px rgba(0,0,0,0.18); }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; box-shadow: 0 6px 16px rgba(16,185,129,0.3); }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(16,185,129,0.32); }
        .btn-success:active { transform: translateY(0); box-shadow: inset 0 3px 8px rgba(0,0,0,0.18); }
        .btn-icon-left { display: inline-flex; align-items: center; gap: 6px; }
        .btn-icon-left .icon { font-size: 1.1em; line-height: 1; }
        #download-tab h4::before { display: none; }
        .toolbar-chunk .btn, .view-switcher-btn { background: var(--card-bg-start); color: var(--text-color); border: 1px solid var(--card-border); box-shadow: 0 2px 6px var(--card-shadow-light); font-weight: 500; }
        .toolbar-chunk .btn:hover, .view-switcher-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px var(--card-shadow-light); }
        .toolbar-chunk .btn:active, .view-switcher-btn:active { transform: translateY(0); box-shadow: inset 0 2px 5px rgba(0,0,0,0.15); }
        .view-switcher-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); box-shadow: 0 3px 10px rgba(255, 140, 66, 0.4); }
        .view-switcher-btn.active:hover { box-shadow: 0 5px 15px rgba(255, 140, 66, 0.5); }
        .table-responsive { overflow-x: auto; border-radius: var(--border-radius); box-shadow: 0 12px 28px rgba(0,0,0,0.06); border: 1px solid var(--card-border); background: #fff; }
        .table-responsive table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .table-responsive th, .table-responsive td { padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--card-border); background-color: var(--card-bg-start); }
        .table-responsive th { background: #f7f9fc; font-weight: 700; color: var(--text-color); position: sticky; top: 0; z-index: 10; }
        .table-responsive tbody tr:last-child td { border-bottom: none; }
        .table-responsive tbody tr:nth-child(odd) td { background: #fbfdff; }
        .table-responsive tbody tr:hover td { background-color: var(--primary-light); transition: background 0.2s ease; }
        #my-signups-result tbody tr:hover { background-color: var(--primary-light); }
        #simple-list-view .table-responsive tbody tr:hover { background-color: var(--primary-light); cursor: pointer; }
        #my-signups-result tbody tr { cursor: default; }
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 12px; vertical-align: middle; border: 1px solid rgba(0,0,0,0.15); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        #custom-calendar-toolbar { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; margin-bottom: 18px; flex-wrap: wrap; gap: 12px; }
        #custom-calendar-title { margin: 0; font-size: 1.5em; font-weight: 800; color: var(--primary-dark); }
        .toolbar-chunk { display: flex; gap: 10px; }
        .fc-event { cursor: pointer; border-radius: var(--border-radius-sm); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: var(--transition-fast); }
        .fc-event:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .event-popover { display: none; position: absolute; z-index: 10000; background: linear-gradient(135deg, var(--card-bg-start), var(--card-bg-end)); border: 1px solid var(--card-border); border-radius: var(--border-radius); box-shadow: 0 12px 35px rgba(0,0,0,0.2), 0 6px 15px rgba(0,0,0,0.1); padding: 20px; width: 320px; max-width: 90vw; color: var(--text-color); }
        .event-popover h5 { font-size: 1.3rem; margin-bottom: 10px; color: var(--primary-dark); }
        .event-popover p, .event-popover ul { margin:0; padding:0; font-size: 0.95rem; }
        .event-popover ul { list-style: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--card-border); }
        .event-popover ul li { margin-bottom: 5px; }
        .event-popover strong { color: var(--primary-dark); }
        #stats-details-container, #performance-details-container { margin-top: 40px; }
        #stats-details-container h2, #performance-details-container h2 { font-size: 1.5rem; text-align: left; border-bottom: 1px solid var(--card-border); padding-bottom: 10px; margin-bottom: 20px; }
        .stats-event-block { page-break-inside: avoid; margin-bottom: 15px; border: 1px solid #eee; padding: 15px; border-radius: 8px; background: #fdfdfd; }
        .stats-event-block h3 { font-size: 1.2rem; margin: 0 0 10px 0; color: var(--primary-dark); }
        .stats-event-block p { margin: 0 0 5px 0; font-size: 0.9rem; }
        .stats-event-block ul { list-style-type: none; padding-left: 0; margin: 10px 0 0 0; font-size: 0.85rem; }
        .stats-event-block li { background: #f8f9fa; padding: 5px 10px; border-radius: 3px; margin-bottom: 3px; }
        @media (min-width: 769px) {
            #stats-details-container, #performance-details-container { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 20px 0; }
            #stats-details-container > h2, #performance-details-container > h2 { flex-basis: 100%; margin-bottom: 0; }
            #stats-details-container .stats-event-block, #performance-details-container .stats-event-block { width: 48.5%; margin-bottom: 0; }
            .stats-event-block h3 { font-size: 1.1rem; } .stats-event-block p { font-size: 0.85rem; } .stats-event-block ul { font-size: 0.8rem; }
        }
        #marquee-container { min-height: 44px; background: linear-gradient(135deg, rgba(31,122,236,0.08), rgba(31,122,236,0.02)); color: #d32f2f; border-radius: var(--border-radius-sm); margin-bottom: 20px; padding: 0 20px; position: relative; overflow: hidden; display: flex; align-items: center; box-shadow: inset 0 1px 2px rgba(0,0,0,0.03), 0 8px 16px rgba(0,0,0,0.03); border: 1px solid var(--card-border); transition: max-height 0.4s ease-out, opacity 0.3s ease-out, margin-bottom 0.4s ease-out; }
        #marquee-text { position: absolute; width: calc(100% - 40px); text-align: center; font-weight: 700; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; letter-spacing: 0.2px; color: #d32f2f; }
        @keyframes marquee-scroll { 0% { transform: translateY(120%); opacity: 0; } 15% { transform: translateY(0); opacity: 1; } 85% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-120%); opacity: 0; } }
        #admin-tab .button-grid, #download-tab .button-grid { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top: 10px; }
        #admin-tab .button-grid .btn, #download-tab .button-grid .btn { flex-grow: 1; }
        @media (min-width: 769px) { .container { width: 90vw; max-width: 1600px; } }
        @media (max-width: 768px) {
            html { height: 100%; }
            body { padding: 12px; margin: 0; min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }
            .page-header { margin-bottom: 12px; flex-shrink: 0; }
            .page-header h1 { font-size: 1.4rem; }
            #toggle-marquee-btn { display: inline-flex; }
            .container { padding: 18px 14px; border-radius: var(--border-radius); box-shadow: 0 8px 20px var(--card-shadow-dark); display: flex; flex-direction: column; overflow-x: hidden; }
            .page-footer { margin-top: 12px; padding: 10px; flex-shrink: 0; background: var(--bg-color); }
            .tabs { gap: 6px; padding: 6px; border: 1px solid var(--card-border); border-radius: 14px; box-shadow: 0 6px 14px rgba(0,0,0,0.06); margin-bottom: 14px; justify-content: center; flex-wrap: wrap; overflow: visible; }
            .tab-button { flex: 0 1 calc(33.33% - 12px); max-width: calc(33.33% - 12px); min-width: 0; height: 70px; font-size: 0.88rem; font-weight: 800; padding: 8px 6px; border-radius: 12px; box-shadow: 0 3px 8px rgba(0,0,0,0.05); display: inline-flex; flex-direction: column; gap: 5px; align-items: center; justify-content: center; white-space: normal; text-align: center; line-height: 1.2; }
            .tab-button .tab-icon { display: block; font-size: 1.4rem; line-height: 1; }
            .tab-button .tab-label { display: block; font-size: 0.95rem; line-height: 1.15; }
            #download-tab h4 { justify-content: center; text-align: center; }
            .tab-button:nth-child(1) { background: linear-gradient(145deg, #2563eb, #1d4ed8); color: #fff; }
            .tab-button:nth-child(2) { background: linear-gradient(145deg, #16a34a, #15803d); color: #fff; }
            .tab-button:nth-child(3) { background: linear-gradient(145deg, #f59e0b, #d97706); color: #fff; }
            .tab-button:nth-child(4) { background: linear-gradient(145deg, #8b5cf6, #7c3aed); color: #fff; }
            .tab-button:nth-child(5) { background: linear-gradient(145deg, #ec4899, #db2777); color: #fff; }
            .tab-button:nth-child(6) { background: linear-gradient(145deg, #06b6d4, #0891b2); color: #fff; }
            .tab-button.active { box-shadow: 0 10px 20px rgba(0,0,0,0.18), 0 0 0 3px rgba(255,255,255,0.7), 0 0 0 6px rgba(31,122,236,0.35); transform: translateY(-2px); }
            #custom-calendar-toolbar { display: flex; flex-wrap: nowrap; justify-content: space-between; align-items: center; gap: 8px; }
            #custom-calendar-title { order: 0; flex: 0 1 auto; font-size: 1.05rem; text-align: center; white-space: nowrap; }
            .toolbar-chunk { order: 0; flex: 0 1 auto; justify-content: center; gap: 6px; }
            .toolbar-chunk .btn { padding: 8px 10px; font-size: 0.9rem; }
            .inline-form { flex-direction: column; align-items: stretch; width: 100%; padding: 12px; gap: 10px; }
            .inline-form > .form-group, .inline-form > .btn { width: 100%; max-width: 100%; margin: 0; }
            .form-group input[type="date"] { -webkit-appearance: none; appearance: none; min-width: 0; width: 100%; }
            #admin-tab .button-grid .btn, #download-tab .button-grid .btn { flex-basis: calc(50% - 7.5px); flex-grow: 1; }
            .btn { padding: 12px 16px; font-size: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transform: translateY(0); }
            .btn-primary:hover, .btn-danger:hover, .toolbar-chunk .btn:hover, .view-switcher-btn:hover { transform: translateY(0); box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
            .btn-primary:active, .btn-danger:active, .toolbar-chunk .btn:active, .view-switcher-btn:active { box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
            .event-popover { width: 95vw; left: 2.5vw !important; transform: translateX(0) !important; }
            #marquee-container { margin-bottom: 16px; padding: 10px 12px; height: auto; min-height: 40px; max-height: 200px; opacity: 1; }
            #marquee-text { position: relative; width: 100%; white-space: normal; text-align: left; animation: none !important; transition: opacity 0.4s ease-in-out; opacity: 1; }
            #simple-list-view .table-responsive th, #simple-list-view .table-responsive td, #my-signups-result .table-responsive th, #my-signups-result .table-responsive td { font-size: 14px !important; padding: 12px 10px !important; }
        }
        #simple-list-view .table-responsive, #my-signups-result .table-responsive { overflow-x: auto !important; -webkit-overflow-scrolling: touch; }
        #simple-list-view .table-responsive table, #my-signups-result .table-responsive table { width: max-content !important; min-width: 100%; }
        #simple-list-view .table-responsive th, #simple-list-view .table-responsive td, #my-signups-result .table-responsive th, #my-signups-result .table-responsive td { white-space: nowrap !important; vertical-align: middle !important; }
        .scroll-hint { text-align: center; font-size: 0.9rem; color: #d32f2f; margin: 5px 0; display: none; font-weight: 600; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
        .floating-scroll-btn { position: fixed; top: 36%; transform: translateY(-50%); width: 40px; height: 40px; border-radius: 50%; background-color: rgba(31, 122, 236, 0.85); color: white; border: none; font-size: 1.5rem; display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 999; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: opacity 0.3s; }
        .floating-scroll-btn:active { background-color: rgba(15, 76, 163, 0.9); }
        .floating-scroll-btn.left { left: 10px; }
        .floating-scroll-btn.right { right: 10px; }
        @media (max-width: 768px) { .scroll-hint { display: block; } .floating-scroll-btn { display: none; } .floating-scroll-btn.visible { display: flex; } }
        .page-fab-container { position: fixed; right: 14px; bottom: 14px; display: flex; flex-direction: column; gap: 10px; z-index: 1100; }
        .page-fab { width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; background-color: rgba(31, 122, 236, 0.85); color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 1.1rem; font-weight: 700; letter-spacing: 0.2px; transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease; }
        .page-fab:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.22); }
        .page-fab:active { transform: translateY(0); box-shadow: inset 0 3px 8px rgba(0,0,0,0.15); }
        .page-fab.hidden { opacity: 0; pointer-events: none; transform: translateY(4px); box-shadow: none; }
        @keyframes bark-pulse { 0% { transform: scale(1); } 20% { transform: scale(1.08); } 50% { transform: scale(1.18); } 80% { transform: scale(1.08); } 100% { transform: scale(1); } }
        .marquee-bark { animation: bark-pulse 0.6s ease-in-out 3; }
    
        /* Admin tab specific style overrides */
        #admin-tab h4::before { display: none; }
        #performance-tab h4::before { display: none; }
        #admin-tab h4, #performance-tab h4 { gap: 0; justify-content: center; }
        #my-signups-tab h4::before { display: none; }
/* --- MOBILE DATE INPUT FIX (追加) --- */
@media (max-width: 768px) {
  .inline-form {
    flex-direction: column;
    align-items: center;
  }
  .inline-form > .form-group,
  .inline-form > .btn {
    width: 92vw;
    max-width: 480px;
  }
  .inline-form .form-group > input,
  .inline-form .form-group > select {
    width: 100%;
    box-sizing: border-box;
  }
  .inline-form input[type="date"] {
    -webkit-appearance: none;
    appearance: none;
    min-width: 0;
    max-width: 100%;
  }
}


/* --- HOTFIX: 修正手機超出容器（覆寫前一版 92vw 設定） --- */
@media (max-width: 768px) {
  .inline-form { 
    flex-direction: row !important;
    flex-wrap: wrap !important;
    align-items: stretch !important; 
    justify-content: space-between !important;
    width: 100% !important;
    gap: 4px !important;
  }
  .inline-form > .form-group,
  .inline-form > .btn {
    width: 100% !important;
    max-width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    flex: 0 0 100%;
    margin-bottom: 0 !important;
  }
  /* 讓所有頁籤的日期選擇器在手機上並排 */
  .inline-form .form-group-date {
    width: calc(50% - 2px) !important;
    max-width: calc(50% - 2px) !important;
    flex: 0 0 calc(50% - 2px) !important;
    min-width: 0 !important;
    padding: 0 1px !important;
  }
  .inline-form .form-group > input,
  .inline-form .form-group > select {
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box;
    padding: 2px 4px !important;
    height: 36px !important;
    font-size: 0.95rem !important;
  }
  .inline-form input[type="date"] {
    -webkit-appearance: none;
    appearance: none;
    min-width: 0;
    width: 100% !important;
    max-width: 100% !important;
    padding: 0 !important;
    text-align: center;
  }
  .inline-form .form-group label {
    margin-bottom: 2px !important;
    font-size: 0.85rem !important;
  }
  .inline-form .btn {
    padding: 6px 12px !important;
    height: 38px !important;
    display: flex;
    align-items: center;
    justify-content: center;
  }
}

</style>
</head>
<body>
    
                    <header class="page-header">
        <h1>
            <span class="brand-icon" onclick="reloadSystem()" title="重新整理">
                <img src="cam.png" alt="攝影機">
            </span>
            AV放送立願表
            <span id="toggle-marquee-btn" title="切換公告欄顯示">&#128276;</span>
        </h1>
    </header>

    <div class="container">
        <div id="marquee-container">
            <div id="marquee-text">載入中...</div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'calendar-tab')"><span class="tab-icon">&#x1F4C5;</span><span class="tab-label">立願</span></button>
            <button class="tab-button" onclick="openTab(event, 'my-signups-tab')"><span class="tab-icon">&#x1F50D;</span><span class="tab-label">查詢</span></button>
            <button class="tab-button" onclick="openTab(event, 'stats-tab')"><span class="tab-icon">&#x1F4CA;</span><span class="tab-label">統計</span></button>
            <button class="tab-button" onclick="openTab(event, 'performance-tab')"><span class="tab-icon">&#x1F4C8;</span><span class="tab-label">績效</span></button>
            <button class="tab-button" onclick="openTab(event, 'download-tab')"><span class="tab-icon">&#x1F4E5;</span><span class="tab-label">下載</span></button>
            <button class="tab-button" onclick="openTab(event, 'admin-tab')"><span class="tab-icon">&#9881;</span><span class="tab-label">管理</span></button>
        </div>

        <div id="calendar-tab" class="tab-content active">
             <div id="custom-calendar-toolbar">
                <div class="toolbar-chunk">
                    <button id="custom-prev-btn" class="btn">&#8592;</button>
                    <button id="custom-today-btn" class="btn">今天</button>
                    <button id="custom-next-btn" class="btn">&#8594;</button>
                </div>
                <h3 id="custom-calendar-title"></h3>
                <div class="toolbar-chunk">
                    <button id="show-full-view-btn" class="btn view-switcher-btn">完整</button>
                    <button id="show-simple-view-btn" class="btn view-switcher-btn">簡易</button>
                </div>
            </div>
            <div id="full-calendar-view"><div id="calendar"></div></div>
            <div id="simple-list-view" style="display: none;"></div>
        </div>

        <div id="my-signups-tab" class="tab-content">
            <h4 style="justify-content:center;text-align:center;"><span class="title-icon">&#x1F50D;</span>綜合報名查詢</h4>
            <div class="inline-form">
                <div class="form-group"><label for="event-select">法會</label><select id="event-select"><option value="">-- 請選擇法會 --</option></select></div>
                <div class="form-group"><label for="universal-search-input">關鍵字</label><input type="text" id="universal-search-input" placeholder="姓名/活動/崗位/描述"></div>
                <div class="form-group form-group-date"><label for="search-start-date">開始日期</label><input type="date" id="search-start-date"></div>
                <div class="form-group form-group-date"><label for="search-end-date">結束日期</label><input type="date" id="search-end-date"></div>
                <button id="unified-search-btn" class="btn btn-primary btn-icon-left"><span class="icon">&#x1F50D;</span><span>查詢</span></button>
                <button id="clear-search-btn" class="btn btn-icon-left" style="background-color: #6c757d; color: white;"><span class="icon">&#x1F504;</span><span>清除</span></button>
            </div>
            <div id="my-signups-result"></div>
            <div id="query-actions-container" style="text-align: center; margin-top: 25px; display: none; flex-wrap: wrap; gap: 15px; justify-content: center;">
                <button id="export-from-query-btn" class="btn btn-primary">產生並下載 Excel</button>
                <button id="share-query-to-clipboard-btn" class="btn btn-success" style="background-color: #17a2b8;">分享至剪貼簿</button>
            </div>
        </div>

        <div id="stats-tab" class="tab-content">
            <div class="inline-form">
                <div class="form-group form-group-date"><label for="stats-start-date">開始日期</label><input type="date" id="stats-start-date"></div>
                <div class="form-group form-group-date"><label for="stats-end-date">結束日期</label><input type="date" id="stats-end-date"></div>
                <button id="generate-stats" class="btn btn-primary btn-icon-left"><span class="icon">&#x1F50D;</span><span>產生報表</span></button>
                <button id="reset-stats-btn" class="btn btn-icon-left" style="background-color: #6c757d; color: white;"><span class="icon">&#x1F504;</span><span>清除</span></button> </div>
            <div class="chart-container" style="position: relative; height:40vh; margin-bottom: 20px;"><canvas id="stats-chart"></canvas></div>
            <div id="stats-details-container"></div>
        </div>

        <div id="performance-tab" class="tab-content">
            <h4>&#x1F4C8; 立願績效圖表 (依個人統計)</h4>
            <div class="inline-form">
                <div class="form-group form-group-date"><label for="performance-start-date">開始日期</label><input type="date" id="performance-start-date"></div>
                <div class="form-group form-group-date"><label for="performance-end-date">結束日期</label><input type="date" id="performance-end-date"></div>
                <button id="generate-performance-report" class="btn btn-primary btn-icon-left"><span class="icon">&#x1F4C8;</span><span>產生績效圖表</span></button>
                <button id="reset-performance-btn" class="btn btn-icon-left" style="background-color: #6c757d; color: white;"><span class="icon">&#x1F504;</span><span>清除</span></button>
            </div>
            <div class="chart-container" style="position: relative; height:60vh; margin-bottom: 20px;"><canvas id="performance-chart"></canvas></div>
            <div id="performance-details-container"></div>
        </div>
        <div id="download-tab" class="tab-content">
            <h4 style="justify-content:center;text-align:center;"><span class="title-icon">&#x1F4C2;</span>相關文件下載</h4>
            <div class="button-grid">
                <button id="download-jobhtml" class="btn btn-primary btn-icon-left" onclick="window.open('job.html', '_blank')"><span class="icon">&#x1F4D1;</span><span>奉仕崗位職掌（網頁版）</span></button>
                <button id="download-poster" class="btn btn-primary btn-icon-left"><span class="icon">&#x1F5BC;</span><span>AV招生海報</span></button>
                <button id="download-manual-night" class="btn btn-primary btn-icon-left"><span class="icon">&#x1F4D8;</span><span>一如祈念次第(晚上)</span></button>
                <button id="download-manual-day" class="btn btn-primary btn-icon-left"><span class="icon">&#x1F4D8;</span><span>一如祈念次第(白天)</span></button>
                <button id="download-bulletin" class="btn btn-primary btn-icon-left"><span class="icon">&#x1F4C4;</span><span>放送奉侍佈告</span></button>
                <button id="download-live-stream-guide" class="btn btn-primary btn-icon-left"><span class="icon">&#x1F3A5;</span><span>直播開啟及關閉方式</span></button>
            </div>
            <hr style="margin-bottom: 8px;">
            <h4 style="justify-content:center;text-align:center; margin-top: 0.35rem;"><span class="title-icon">&#x1F9ED;</span>SOP文件下載</h4>
            <div class="button-grid">
                <button id="download-doc-computer" class="btn btn-primary btn-icon-left"><span class="icon">&#x1F4BB;</span><span>電腦</span></button>
                <button id="download-doc-lighting" class="btn btn-primary btn-icon-left"><span class="icon">&#x1F4A1;</span><span>燈光</span></button>
                <button id="download-doc-audio" class="btn btn-primary btn-icon-left"><span class="icon">&#x1F39A;</span><span>音控</span></button>
                <button id="download-doc-camera" class="btn btn-primary btn-icon-left"><span class="icon">&#x1F4F7;</span><span>攝影</span></button>
            </div>
            <hr style="margin-bottom: 8px;">
            <h4 style="justify-content:center;text-align:center; margin-top: 0.35rem;"><span class="title-icon">&#x1F3AC;</span>影音檔案下載</h4>
            <div class="button-grid">
                <button id="download-video-signup-sop" class="btn btn-primary btn-icon-left"><span class="icon">&#x2705;</span><span>立願報名SOP</span></button>
                <button id="download-video-delete-sop" class="btn btn-primary btn-icon-left"><span class="icon">&#x1F5D1;</span><span>立願刪除SOP</span></button>
                <button id="download-video-query-sop" class="btn btn-primary btn-icon-left"><span class="icon">&#x1F50E;</span><span>立願查詢SOP</span></button>
                <button id="download-video-cable-wrap" class="btn btn-primary btn-icon-left"><span class="icon">&#x1FAA2;</span><span>攝影師收線示範</span></button>
            </div>
        </div>
        <div id="admin-tab" class="tab-content">
            <hr style="margin-top:0; margin-bottom: 12px;">
            <h4 style="margin-top: 0.25rem;"><span class="title-icon">&#9881;</span>分享奉侍名單</h4>
            <div class="inline-form" style="justify-content: center;">
                <div class="form-group form-group-date"><label for="export-start-date">開始日期</label><input type="date" id="export-start-date"></div>
                <div class="form-group form-group-date"><label for="export-end-date">結束日期</label><input type="date" id="export-end-date"></div>
                <button id="share-to-clipboard-btn" class="btn btn-primary btn-icon-left">
                    <span class="icon">&#x1F4CB;</span><span>分享至剪貼簿</span>
                </button>
                <button id="admin-reset-btn" class="btn btn-icon-left" style="background-color: #6c757d; color: white;"><span class="icon">&#x1F504;</span><span>清除</span></button>
            </div>
            <hr style="margin-bottom: 12px;">
            <h4 style="margin-top: 0.25rem;"><span class="title-icon">&#x1F4E2;</span>LINE 通知設定 (Messaging API)</h4>
            <div class="button-grid">
                <button id="setup-line-trigger-btn" class="btn btn-success btn-icon-left">
                    <span class="icon">&#x23F0;</span><span>啟動每日 20:00 自動通知</span>
                </button>
                <button id="test-line-notify-btn" class="btn btn-primary btn-icon-left" style="background-color: #17a2b8;">
                    <span class="icon">&#x1F4E9;</span><span>立即測試發送 (明天名單)</span>
                </button>
            </div>
        </div>
    </div>
    
    <div class="page-fab-container" aria-label="快速滾動">
        <button class="page-fab" id="scroll-top-btn" aria-label="回到最上方">↑</button>
        <button class="page-fab" id="scroll-bottom-btn" aria-label="前往最下方">↓</button>
    </div>

    <div id="event-popover" class="event-popover"></div>
    <audio id="dog-audio" src="dog.wav" preload="auto" playsinline></audio>
    <footer class="page-footer">
        <p>c 2026 AV 放送立願系統. All Rights Reserved.</p>
        <span id="frontend-version" style="display:none;"></span>
        <span id="backend-version" style="display:none;"></span>
    </footer>
    <div id="loading" class="loading-overlay" style="display: none;"></div>

    <script>
        const FRONTEND_VERSION = "0717";
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz1dCHAzjMNklN96jXKpWYcTv-NvzKoB8J6CcY30L55dAtaAf0bTRWTJTc20Fk2MZbgeQ/exec"; 
        
        function reloadSystem() {
            showLoading();
            localStorage.setItem('av_active_tab', 'calendar-tab');
            setTimeout(() => { location.reload(); }, 200);
        }
        let calendar = null, statsChart, performanceChart, allCalendarEvents = [], currentDisplayDate = new Date(), lastQuery = { type: null, params: {}, data: [] }, lastStatsData = null, eventHandlingInProgress = false;
        const isMobile = window.innerWidth <= 768;
        let currentCalendarOptions = { height: isMobile ? 'auto' : undefined, aspectRatio: isMobile ? 0.8 : 1.35 };
        function showLoading() { document.getElementById('loading').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loading').style.display = 'none'; }
        
        function callAppsScript(functionName, params = {}) { return new Promise((resolve, reject) => { const callbackName = 'jsonpCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9); function makeRequest() { const timeoutId = setTimeout(() => { if (window[callbackName]) delete window[callbackName]; const scriptEl = document.getElementById(callbackName); if (scriptEl && scriptEl.parentNode) scriptEl.parentNode.removeChild(scriptEl); reject(new Error('請求超時，請檢查網路連線或稍後再試。')); }, 90000); window[callbackName] = (response) => { clearTimeout(timeoutId); try { const scriptEl = document.getElementById(callbackName); if (scriptEl && scriptEl.parentNode) scriptEl.parentNode.removeChild(scriptEl); delete window[callbackName]; } catch (e) { console.error("清理 JSONP 腳本時出錯:", e); } if (response && response.status === 'success') { resolve(response); } else { reject(new Error(response.message || '後端服務回傳錯誤。')); } }; const script = document.createElement('script'); script.id = callbackName; const encodedPayload = encodeURIComponent(JSON.stringify({ functionName, params })); script.src = `${SCRIPT_URL}?callback=${callbackName}&payload=${encodedPayload}&_t=${Date.now()}`; script.onerror = () => { clearTimeout(timeoutId); hideLoading(); if (window[callbackName]) delete window[callbackName]; if (script.parentNode) script.parentNode.removeChild(script); reject(new Error('網路請求失敗，請檢查部署網址與權限設定。')); }; document.head.appendChild(script); } makeRequest(); }); }
        async function callAppsScriptWithRetry(functionName, params = {}, attempts = 3, delayMs = 1200) { let lastError; for (let i = 1; i <= attempts; i++) { try { return await callAppsScript(functionName, params); } catch (e) { lastError = e; if (i < attempts) { await new Promise(res => setTimeout(res, delayMs)); } } } throw lastError; }
        
        function openTab(evt, tabName) { localStorage.setItem('av_active_tab', tabName); document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none'); document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active')); document.getElementById(tabName).style.display = 'block'; evt.currentTarget.classList.add('active'); if (tabName === 'calendar-tab' && calendar) { setTimeout(() => { calendar.updateSize(); }, 0); } }
        async function promptForName() { let currentUserName = localStorage.getItem('av_signup_username') || ''; const { value: name } = await Swal.fire({ title: "請輸入您的姓名", input: "text", inputValue: currentUserName, inputPlaceholder: "請輸入姓名", showCancelButton: true, inputValidator: (v) => !v && "姓名不能為空！" }); if (name) { localStorage.setItem('av_signup_username', name); } return name; }
        async function handleEventClick(info) {
            if (eventHandlingInProgress) return;
            eventHandlingInProgress = true;
            try {
            const eventObject = allCalendarEvents.find(e => e.id === info.event.id); if (!eventObject) { eventHandlingInProgress = false; return; }
            const props = eventObject.extendedProps;
            const eventEndDateTime = eventObject.end ? new Date(eventObject.end) : new Date(eventObject.start);
            if (!eventObject.end) { eventEndDateTime.setHours(23, 59, 59, 999); }
            if (new Date() > eventEndDateTime) { await Swal.fire({ icon: 'warning', title: '活動已結束', text: '此活動的報名時間已截止，無法進行操作。', confirmButtonColor: '#d33' }); eventHandlingInProgress = false; return; }
            const name = await promptForName(); if (!name) { eventHandlingInProgress = false; return; }
            const existingSignup = props.signups.find(s => s.user === name); 
            if (existingSignup) { await Swal.fire({ icon: 'info', title: '您已報名過此活動', html: `<div style="text-align: left; padding: 0 1em;"><p><strong>活動：</strong> ${props.full_title}</p><p><strong>日期：</strong> ${new Date(eventObject.start).toLocaleDateString('en-CA')}</p><p><strong>您報名的崗位：</strong> ${existingSignup.position}</p></div>` }); eventHandlingInProgress = false; return; }
            const allBackendPositions = props.positions; 
            if (!allBackendPositions || allBackendPositions.length === 0) { await Swal.fire('無可報名崗位', '此活動尚未設定任何可報名的崗位。', 'info'); eventHandlingInProgress = false; return; }
            const positionOptions = allBackendPositions.reduce((obj, pos) => ({...obj, [pos]: pos}), {});
            let timeText = `<b>開始時間:</b> ${props.startTime}${props.endTime ? '<br><b>結束時間:</b> ' + props.endTime : ''}`;
            const { value: selectedPosition } = await Swal.fire({ title: props.full_title, html: `${timeText}<br><br><b>說明:</b> ${props.description || '無'}<br><br><p style="color: red; font-weight: bold;">當立願崗位重複時，在法會當天奉仕讀經結束後，因準備工作需要，始可由其他人員遞補。您的立願崗位優先保留至奉仕讀經結束。</p>`, input: 'select', inputOptions: positionOptions, inputPlaceholder: '選擇崗位', showCancelButton: true, confirmButtonText: '確認報名', cancelButtonText: '取消', preConfirm: p => !p ? Swal.showValidationMessage('請選擇一個崗位') : p });
            if (selectedPosition) {
                showLoading();
                try {
                    const response = await callAppsScript('addSignup', { eventId: info.event.id, userName: name, position: selectedPosition });
                    let successPayload = { icon: 'success' };
                    if (response.data.status === 'confirm_backup') {
                        const { isConfirmed } = await Swal.fire({ title: '崗位已被報名', text: response.data.message, icon: 'question', showCancelButton: true, confirmButtonText: '是, 我要報名備援', cancelButtonText: '取消' });
                        if (!isConfirmed) { hideLoading(); return; }
                        showLoading();
                        await callAppsScript('addBackupSignup', { eventId: info.event.id, userName: name, position: selectedPosition });
                        successPayload.title = '備援報名成功！';
                        successPayload.html = `<div style="text-align: left; padding: 0 1em;"><p><strong>姓名：</strong> ${name}</p><p><strong>活動：</strong> ${props.full_title}</p><p><strong>崗位：</strong> ${selectedPosition} (備援)</p></div>`;
                    } else {
                        successPayload.title = '報名成功！';
                        successPayload.html = `<div style="text-align: left; padding: 0 1em;"><p><strong>姓名：</strong> ${name}</p><p><strong>活動：</strong> ${props.full_title}</p><p><strong>崗位：</strong> ${selectedPosition}</p></div>`;
                    }
                    await Swal.fire(successPayload);
                    setupCalendarTab(true); 
                } catch(error) { Swal.fire('報名失敗', error.message, 'error'); } 
                finally { hideLoading(); }
            }
            } finally { eventHandlingInProgress = false; }
        }
        function showEventPopover(info) {
            const isCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
            if (isMobile || isCoarse) return;
            const { event, el } = info; const props = event.extendedProps; const popoverEl = document.getElementById('event-popover'); let content = `<h5>${props.full_title}</h5><p><b>日期:</b> ${new Date(event.start).toLocaleDateString('en-CA')}</p><p><b>時間:</b> ${props.startTime}${props.endTime ? ' - ' + props.endTime : ''}</p><p><b>額滿人數:</b> ${props.maxAttendees} 人</p>`; if (props.description) { content += `<p><b>說明:</b> ${props.description}</p>`; } if (props.signups && props.signups.length > 0) { content += '<hr style="margin: 8px 0; border-top: 1px dashed var(--card-border);"><ul>'; props.signups.forEach(s => { content += `<li><strong>${s.position}:</strong> ${s.user}</li>`; }); content += '</ul>'; } else { content += '<p style="margin-top: 8px;">目前尚無人報名</p>'; } popoverEl.innerHTML = content; popoverEl.style.visibility = 'hidden'; popoverEl.style.display = 'block'; const rect = el.getBoundingClientRect(); const popoverHeight = popoverEl.offsetHeight; const popoverWidth = popoverEl.offsetWidth; const margin = 10; let left = rect.left + window.scrollX; if (left + popoverWidth > window.innerWidth - margin) { left = window.innerWidth - popoverWidth - margin; } if (left < margin) { left = margin; } let top; if (rect.bottom + popoverHeight + margin > window.innerHeight) { top = rect.top + window.scrollY - popoverHeight - 5; } else { top = rect.bottom + window.scrollY + 5; } if (top < window.scrollY + margin) { top = window.scrollY + margin; } popoverEl.style.left = `${left}px`; popoverEl.style.top = `${top}px`; popoverEl.style.visibility = 'visible';
        }
        function hideEventPopover() { document.getElementById('event-popover').style.display = 'none'; }
        function renderSimpleListView() { const container = document.getElementById('simple-list-view'); document.getElementById('custom-calendar-title').textContent = `${currentDisplayDate.getFullYear()}年 ${currentDisplayDate.getMonth() + 1}月`; const viewStart = new Date(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth(), 1); const viewEnd = new Date(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth() + 1, 0); viewEnd.setHours(23, 59, 59, 999); const currentMonthEvents = allCalendarEvents.filter(e => new Date(e.start) >= viewStart && new Date(e.start) <= viewEnd).sort((a, b) => new Date(a.start) - new Date(b.start)); if (currentMonthEvents.length === 0) { container.innerHTML = '<div class="table-responsive" style="margin-top:0;"><p style="text-align:center; padding: 20px;">本月尚無活動。</p></div>'; return; } let tableHtml = `<div class="scroll-hint">← 左右滑動以查看更多資訊 →</div><div class="table-responsive" id="simple-list-table-container" style="margin-top:0;"><table><thead><tr><th>日期</th><th>星期</th><th>標題</th><th>開始</th><th>結束</th><th>上限 (已報)</th><th>報名詳情</th></tr></thead><tbody>`; currentMonthEvents.forEach(event => { const props = event.extendedProps; const startDate = new Date(event.start); const dateString = startDate.toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' }); const dayOfWeek = startDate.toLocaleDateString('zh-TW', { timeZone: 'Asia/Taipei', weekday: 'short' }); const signupCount = props.signups ? props.signups.length : 0; let signupsDetail = props.signups && props.signups.length > 0 ? props.signups.map(s => `${s.position}：${s.user}`).join('，') : ''; tableHtml += `<tr data-event-id="${event.id}"><td><span class="status-dot" style="background-color: ${event.backgroundColor};"></span>${dateString.substring(5)}</td><td>${dayOfWeek.replace('週', '')}</td><td class="event-title-cell">${event.title}</td><td>${props.startTime || ''}</td><td>${props.endTime || ''}</td><td>${props.maxAttendees} (${signupCount})</td><td>${signupsDetail}</td></tr>`; }); tableHtml += `</tbody></table></div><div class="scroll-hint">← 左右滑動以查看更多資訊 →</div><button class="floating-scroll-btn left" onclick="document.getElementById('simple-list-table-container').scrollBy({left: -200, behavior: 'smooth'})">&#8592;</button><button class="floating-scroll-btn right" onclick="document.getElementById('simple-list-table-container').scrollBy({left: 200, behavior: 'smooth'})">&#8594;</button>`; container.innerHTML = tableHtml; container.querySelectorAll('tbody tr').forEach(row => { const eventId = row.dataset.eventId; const eventObject = allCalendarEvents.find(e => e.id === eventId); if (!eventObject) return; row.addEventListener('click', (e) => { if (e.target.tagName !== 'BUTTON') { handleEventClick({ event: { id: eventId, ...eventObject }, jsEvent: e }) } }); const titleCell = row.querySelector('.event-title-cell'); if (titleCell) { titleCell.addEventListener('mouseenter', (e) => showEventPopover({ event: { extendedProps: eventObject.extendedProps, start: eventObject.start }, el: e.currentTarget })); titleCell.addEventListener('mouseleave', hideEventPopover); } }); const tableContainer = document.getElementById('simple-list-table-container'); const floatBtns = container.querySelectorAll('.floating-scroll-btn'); if (tableContainer && floatBtns.length > 0) { const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { floatBtns.forEach(btn => { if (entry.intersectionRatio >= 0.55) { btn.classList.add('visible'); } else { btn.classList.remove('visible'); } }); }); }, { threshold: 0.55 }); observer.observe(tableContainer); } }
        function initializeFullCalendar() { const calendarEl = document.getElementById('calendar'); if (calendar) calendar.destroy(); let options = { headerToolbar: false, initialDate: currentDisplayDate, locale: 'zh-tw', events: allCalendarEvents, datesSet: (dateInfo) => { currentDisplayDate = dateInfo.view.currentStart; document.getElementById('custom-calendar-title').textContent = dateInfo.view.title; if (document.getElementById('simple-list-view').style.display === 'block') { renderSimpleListView(); } }, eventClick: handleEventClick, eventMouseEnter: showEventPopover, eventMouseLeave: hideEventPopover, ...currentCalendarOptions }; calendar = new FullCalendar.Calendar(calendarEl, options); calendar.render(); }
        async function setupCalendarTab(forceRefresh = false) { if (!forceRefresh && allCalendarEvents.length > 0) { if (calendar) { calendar.refetchEvents(); } else { initializeFullCalendar(); } populateEventSelect(); return; } showLoading(); try { const response = await callAppsScriptWithRetry('getEventsAndSignups'); allCalendarEvents = response.data; if (!document.getElementById('custom-prev-btn')._isInitialized) { document.getElementById('custom-prev-btn').addEventListener('click', () => calendar.prev()); document.getElementById('custom-next-btn').addEventListener('click', () => calendar.next()); document.getElementById('custom-today-btn').addEventListener('click', () => calendar.today()); const fullViewBtn = document.getElementById('show-full-view-btn'); const simpleViewBtn = document.getElementById('show-simple-view-btn'); fullViewBtn.addEventListener('click', () => { document.getElementById('simple-list-view').style.display = 'none'; document.getElementById('full-calendar-view').style.display = 'block'; fullViewBtn.classList.add('active'); simpleViewBtn.classList.remove('active'); currentCalendarOptions = { height: isMobile ? 'auto' : undefined, aspectRatio: isMobile ? 0.8 : 1.35 }; initializeFullCalendar(); calendar.updateSize(); }); simpleViewBtn.addEventListener('click', () => { document.getElementById('full-calendar-view').style.display = 'none'; document.getElementById('simple-list-view').style.display = 'block'; simpleViewBtn.classList.add('active'); fullViewBtn.classList.remove('active'); renderSimpleListView(); }); document.getElementById('custom-prev-btn')._isInitialized = true; } initializeFullCalendar(); if (document.getElementById('simple-list-view').style.display === 'block') { renderSimpleListView(); } else { if (isMobile) { document.getElementById('show-simple-view-btn').click(); } else { document.getElementById('show-full-view-btn').click(); } } populateEventSelect(); } catch (error) { Swal.fire('載入失敗', error.message, 'error'); } finally { hideLoading(); } }
        
        function updateSearchDebug() { return; }
        function renderMySignupsTable(signups) { const resultDiv = document.getElementById('my-signups-result'); const actionsContainer = document.getElementById('query-actions-container'); resultDiv.innerHTML = ''; actionsContainer.style.display = 'none'; updateSearchDebug(); if (!signups || signups.length === 0) { Swal.fire({ icon: 'info', title: '查無資料', text: '在您指定的條件下，找不到相關的報名紀錄。' }); lastQuery.data = []; return; } lastQuery.data = signups; let tableHtml = `<div class="scroll-hint">← 左右滑動以查看更多資訊 →</div><div class="table-responsive" id="my-signups-table-container"><table class="all-signups-table"><thead><tr><th>活動日期</th><th>星期</th><th>活動名稱</th><th>開始時間</th><th>結束時間</th><th>崗位</th><th>姓名</th><th>報名時間</th><th>操作</th></tr></thead><tbody>`; signups.forEach(s => { tableHtml += `<tr><td>${s.eventDate || ''}</td><td>${s.eventDayOfWeek || ''}</td><td>${s.eventTitle || ''}</td><td>${s.startTime || ''}</td><td>${s.endTime || ''}</td><td>${s.position || ''}</td><td>${s.user || ''}</td><td>${s.timestamp || ''}</td><td style="display: flex; gap: 8px; white-space: nowrap;"><button class="btn btn-sm" style="background-color: #ffc107; color: #212529;" onclick='promptToModifySignup(${JSON.stringify(s).replace(/'/g, "\\'")})'>修改</button><button class="btn btn-danger btn-sm" onclick='promptToDeleteSignup(${JSON.stringify(s).replace(/'/g, "\\'")})'>刪除</button></td></tr>`; }); tableHtml += '</tbody></table></div><div class="scroll-hint">← 左右滑動以查看更多資訊 →</div><button class="floating-scroll-btn left" onclick="document.getElementById(\'my-signups-table-container\').scrollBy({left: -200, behavior: \'smooth\'})">&#8592;</button><button class="floating-scroll-btn right" onclick="document.getElementById(\'my-signups-table-container\').scrollBy({left: 200, behavior: \'smooth\'})">&#8594;</button>'; resultDiv.innerHTML = tableHtml; actionsContainer.style.display = 'flex'; const tableContainer = document.getElementById('my-signups-table-container'); const floatBtns = resultDiv.querySelectorAll('.floating-scroll-btn'); if (tableContainer && floatBtns.length > 0) { const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { floatBtns.forEach(btn => { if (entry.isIntersecting) { btn.classList.add('visible'); } else { btn.classList.remove('visible'); } }); }); }, { threshold: 0.1 }); observer.observe(tableContainer); } }
        async function promptToModifySignup(signup) { const eventDetails = allCalendarEvents.find(e => e.id === signup.eventId); if (!eventDetails) { return Swal.fire('錯誤', '找不到此報名的相關活動資訊，無法修改。', 'error'); } const allPositions = eventDetails.extendedProps.positions; if (!allPositions || allPositions.length === 0) { return Swal.fire('錯誤', '此活動沒有可用的崗位列表。', 'error'); } let optionsHtml = allPositions.map(pos => `<option value="${pos}" ${pos === signup.position ? 'selected' : ''}>${pos}</option>`).join(''); const { value: newPosition } = await Swal.fire({ title: '修改報名崗位', html: ` <div style="text-align: left; margin: 1em 0; line-height: 1.8;"><p><strong>活動:</strong> ${signup.eventTitle}</p><p><strong>日期:</strong> ${signup.eventDate}</p><p><strong>時間:</strong> ${eventDetails.extendedProps.startTime || ''}${eventDetails.extendedProps.endTime ? ' - ' + eventDetails.extendedProps.endTime : ''}</p><p><strong>姓名:</strong> ${signup.user}</p><hr style="margin: 1rem 0; height: 1px; background: #ddd; border: none;"><p style="margin-top: 1em;"><strong>修改崗位為:</strong></p><select id="swal-position-select" class="swal2-select" style="width: 100%; max-width: 300px; margin-top: 0.5em;">${optionsHtml}</select></div>`, width: isMobile ? '90vw' : '500px', focusConfirm: false, showCancelButton: true, confirmButtonText: '確認修改', cancelButtonText: '取消', preConfirm: () => document.getElementById('swal-position-select').value }); if (newPosition && newPosition !== signup.position) { showLoading(); try { const response = await callAppsScript('modifySignup', { signupId: signup.signupId, newPosition: newPosition }); await Swal.fire('修改成功', response.data.message, 'success'); executeUnifiedSignupQuery(lastQuery.params.searchText, lastQuery.params.startDateStr, lastQuery.params.endDateStr, lastQuery.params.eventDate || '', lastQuery.params.eventTitle || '', lastQuery.params.keyword || ''); setupCalendarTab(true); } catch (e) { Swal.fire('修改失敗', e.message, 'error'); } finally { hideLoading(); } } }
        function normalizeDateStr(input) { if (!input) return ''; const sanitized = input.replace(/[./]/g, '-'); const parsed = new Date(sanitized); if (isNaN(parsed.getTime())) { return sanitized.slice(0, 10); } return parsed.toLocaleDateString('en-CA'); }
        async function executeUnifiedSignupQuery(searchText, startDateStr, endDateStr, eventDate = '', eventTitle = '', keyword = '') { showLoading(); try { const response = await callAppsScriptWithRetry('getUnifiedSignups', { searchText, startDateStr, endDateStr }); const keywordTokens = (keyword || '').split(/\s+/).filter(Boolean).map(s => s.toLowerCase()); let results = response.data || []; const targetDate = normalizeDateStr(eventDate); if (targetDate && results.length > 0) { results = results.filter(item => normalizeDateStr(item.eventDate) === targetDate); } if (eventTitle && results.length > 0) { results = results.filter(item => item.eventTitle && (item.eventTitle.includes(eventTitle) || eventTitle.includes(item.eventTitle))); } if (keywordTokens.length > 0 && results.length > 0) { results = results.filter(item => { const haystack = [item.eventTitle, item.position, item.user, item.eventDate, item.eventDayOfWeek, item.description].filter(Boolean).join(' ').toLowerCase(); return keywordTokens.every(k => haystack.includes(k)); }); } renderMySignupsTable(results); } catch(e) { Swal.fire('查詢失敗', e.message, 'error'); } finally { hideLoading(); } }
        function populateEventSelect() {
            const eventSelect = document.getElementById('event-select');
            if (!eventSelect) return;
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            lastDayOfMonth.setHours(23, 59, 59, 999);
            const currentMonthEvents = allCalendarEvents.filter(e => {
                const eventDate = new Date(e.start);
                return eventDate >= firstDayOfMonth && eventDate <= lastDayOfMonth;
            }).sort((a, b) => new Date(a.start) - new Date(b.start));
            eventSelect.innerHTML = '<option value="">-- 請選擇法會 --</option>';
            currentMonthEvents.forEach(event => {
                const eventDate = new Date(event.start);
                const dateString = eventDate.toLocaleDateString('en-CA');
                const displayText = `${dateString} ${event.extendedProps.full_title || event.title}`;
                const option = document.createElement('option');
                option.value = JSON.stringify({ date: dateString, title: event.extendedProps.full_title || event.title });
                option.textContent = displayText;
                eventSelect.appendChild(option);
            });
        }
        async function promptToDeleteSignup(signup) { const { value: password } = await Swal.fire({ title: '確定要刪除此筆報名嗎？', html: `<div style="text-align: left; margin: 1em auto; background: #f8f9fa; border-left: 4px solid #e74c3c; padding: 1em; border-radius: 4px; width: 90%;"><p><strong>活動日期:</strong> ${signup.eventDate || 'N/A'}</p><p><strong>活動名稱:</strong> ${signup.eventTitle || 'N/A'}</p><p><strong>報名人員:</strong> ${signup.user || 'N/A'}</p><p><strong>報名崗位:</strong> ${signup.position || 'N/A'}</p><p><strong>報名時間:</strong> ${signup.timestamp || 'N/A'}</p></div><div style="text-align: center; margin-top: 1.5em;"><p style="margin-bottom: 0.5em;">請輸入密碼以確認刪除：</p><input type="password" id="password-input" class="swal2-input" placeholder="請輸入密碼" style="width: 90%; margin: 0 auto;"></div>`, icon: 'warning', showCancelButton: true, confirmButtonText: '確認刪除', cancelButtonText: '取消', preConfirm: () => { const pw = document.getElementById('password-input').value; if (pw !== '0425') { Swal.showValidationMessage('密碼錯誤！'); return false; } return pw; } }); if (password) { showLoading(); try { const response = await callAppsScript('removeSignup', { eventId: signup.eventId, userName: signup.user }); await Swal.fire('刪除成功', response.data.message, 'success'); if (lastQuery.type === 'unified') { await executeUnifiedSignupQuery(lastQuery.params.searchText, lastQuery.params.startDateStr, lastQuery.params.endDateStr, lastQuery.params.eventDate || '', lastQuery.params.eventTitle || '', lastQuery.params.keyword || ''); } setupCalendarTab(true); } catch(e) { Swal.fire('刪除失敗', e.message, 'error'); } finally { hideLoading(); } } }
        async function generateStatsReport() { showLoading(); const detailsContainer = document.getElementById('stats-details-container'); detailsContainer.innerHTML = ''; try { const response = await callAppsScriptWithRetry('getStatsData', { startDateStr: document.getElementById('stats-start-date').value, endDateStr: document.getElementById('stats-end-date').value }); const data = response.data; lastStatsData = data; const ctx = document.getElementById('stats-chart').getContext('2d'); if (statsChart) statsChart.destroy(); if (!data || data.labels.length === 0) { document.getElementById('stats-chart').style.display = 'none'; detailsContainer.innerHTML = '<p style="text-align:center; padding: 20px;">在選定的日期範圍?沒有任何報名記錄可供統計。</p>'; Swal.fire('提示', '在選定的日期範圍?沒有任何報名記錄可供統計。', 'info'); return; } document.getElementById('stats-chart').style.display = 'block'; const backgroundColors = data.labels.map(() => `rgba(${Math.floor(Math.random()*200)+50},${Math.floor(Math.random()*200)+50},${Math.floor(Math.random()*200)+50},0.8)`); const chartLabels = data.labels.map(label => { const parts = label.match(/(.*?)\s*\((.*?)\)/); return (parts && parts.length === 3) ? (isMobile ? parts[1].trim() : [parts[1].trim(), `(${parts[2]})`]) : label; }); const chartOptions = { responsive: true, maintainAspectRatio: false, backgroundColor: 'white', plugins: { datalabels: { anchor: 'end', align: 'top', offset: 4, color: '#444', font: { weight: 'bold', size: 14 } }, tooltip: { callbacks: { title: (items) => data.fullDetails[items[0].dataIndex].eventInfo.title, label: (item) => { const d = data.fullDetails[item.dataIndex]; let l = [`日期: ${d.eventInfo.date}`, `時間: ${d.eventInfo.startTime}${d.eventInfo.endTime ? ' - ' + d.eventInfo.endTime : ''}`, `已報名: ${item.raw} / ${d.eventInfo.maxAttendees} 人`, '--- 崗位人員 ---']; d.signups.forEach(s => l.push(`${s.position}: ${s.user}`)); return l; } } } }, scales: { x: { ticks: { autoSkip: false } }, y: { grace: '10%' } }, layout: { padding: { top: 30, bottom: isMobile ? 80 : 40 } } }; if (isMobile) { chartOptions.scales.x.ticks.maxRotation = 45; chartOptions.scales.x.ticks.minRotation = 45; } statsChart = new Chart(ctx, { type: 'bar', data: { labels: chartLabels, datasets: [{ label: '報名人數', data: data.data, backgroundColor: backgroundColors, borderColor: backgroundColors.map(c => c.replace('0.8', '1')), borderWidth: 1 }] }, options: chartOptions }); let detailsHtml = '<h2>詳細活動報名資訊</h2>'; data.fullDetails.forEach((eventData, index) => { const dayOfWeekText = eventData.eventInfo.dayOfWeek ? `(${eventData.eventInfo.dayOfWeek})` : ''; detailsHtml += `<div class="stats-event-block"><h3>${index + 1}. ${eventData.eventInfo.title}</h3><p><strong>日期:</strong> ${eventData.eventInfo.date} ${dayOfWeekText}</p><p><strong>時間:</strong> ${eventData.eventInfo.startTime}${eventData.eventInfo.endTime ? ' - ' + eventData.eventInfo.endTime : ''}</p><p><strong>報名狀況:</strong> ${eventData.signups.length} / ${eventData.eventInfo.maxAttendees}</p>`; if (eventData.signups && eventData.signups.length > 0) { detailsHtml += '<ul>'; eventData.signups.forEach(signup => { detailsHtml += `<li><strong>${signup.position}:</strong> ${signup.user}</li>`; }); detailsHtml += '</ul>'; } else { detailsHtml += '<p>無人報名</p>'; } detailsHtml += '</div>'; }); detailsContainer.innerHTML = detailsHtml; setTimeout(() => { const canvas = document.getElementById('stats-chart'); if (canvas) canvas.style.backgroundColor = 'white'; }, 100); } catch(e) { Swal.fire('產生失敗', e.message, 'error'); } finally { hideLoading(); } }
        async function generatePerformanceReport() {
            showLoading();
            const detailsContainer = document.getElementById('performance-details-container');
            const canvas = document.getElementById('performance-chart');
            const ctx = canvas.getContext('2d');

            try {
                const startDateStr = document.getElementById('performance-start-date').value;
                const endDateStr = document.getElementById('performance-end-date').value;
                const response = await callAppsScriptWithRetry('getUnifiedSignups', { searchText: '', startDateStr, endDateStr });
                const signups = response.data;
                
                if (performanceChart) performanceChart.destroy();
                detailsContainer.innerHTML = '';

                if (!signups || signups.length === 0) {
                    canvas.style.display = 'none';
                    Swal.fire('無資料', '在選定的日期範圍內沒有任何報名記錄可供統計。', 'info');
                    return;
                }
                canvas.style.display = 'block';

                const signupCounts = {};
                const signupsByUser = {};
                signups.forEach(signup => {
                    if (!signup.user) return;
                    signupCounts[signup.user] = (signupCounts[signup.user] || 0) + 1;
                    if (!signupsByUser[signup.user]) {
                        signupsByUser[signup.user] = [];
                    }
                    signupsByUser[signup.user].push({
                        eventDate: signup.eventDate,
                        eventTitle: signup.eventTitle,
                        position: signup.position
                    });
                });

                const sortedData = Object.entries(signupCounts).sort(([, a], [, b]) => b - a);
                const labels = sortedData.map(([user]) => user);
                const data = sortedData.map(([, count]) => count);
                const backgroundColors = data.map(() => `rgba(${Math.floor(Math.random()*155)+100},${Math.floor(Math.random()*155)+100},${Math.floor(Math.random()*155)+100},0.8)`);
                
                performanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '立願次數',
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: backgroundColors.map(c => c.replace('0.8', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: { anchor: 'end', align: 'right', offset: 8, color: '#333', font: { weight: 'bold', size: 14 } }
                        },
                        scales: {
                            x: { beginAtZero: true, ticks: { stepSize: 1 } },
                            y: { ticks: { autoSkip: false } }
                        },
                        layout: { padding: { left: 10, right: 40, top: 10, bottom: 10 } }
                    }
                });

                let detailsHtml = '<h2>個人立願詳細記錄</h2>';
                sortedData.forEach(([user, count]) => {
                    detailsHtml += `<div class="stats-event-block"><h3>${user} - 共 ${count} 次</h3>`;
                    const userSignups = signupsByUser[user] || [];
                    userSignups.sort((a, b) => new Date(a.eventDate) - new Date(b.eventDate));
                    if (userSignups.length > 0) {
                        detailsHtml += '<ul>';
                        userSignups.forEach(s => {
                            detailsHtml += `<li><strong>${s.eventDate}:</strong> ${s.eventTitle} (${s.position})</li>`;
                        });
                        detailsHtml += '</ul>';
                    }
                    detailsHtml += `</div>`;
                });
                detailsContainer.innerHTML = detailsHtml;

            } catch(e) {
                Swal.fire('產生失敗', e.message, 'error');
            } finally {
                hideLoading();
            }
        }
        async function exportCurrentQueryResultToExcel() { if (!lastQuery.type || !lastQuery.params) { return Swal.fire('錯誤', '沒有可匯出的查詢條件。', 'error'); } showLoading(); try { const { searchText, startDateStr, endDateStr } = lastQuery.params; const response = await callAppsScript('getUnifiedSignups', { searchText, startDateStr, endDateStr }); const dataToExport = response.data; if (!dataToExport || dataToExport.length === 0) { hideLoading(); return Swal.fire('無資料', '在選定的條件下沒有任何報名記錄可供匯出。', 'info'); } const dateRangeText = (startDateStr && endDateStr) ? `${startDateStr} - ${endDateStr}` : '所有日期'; const titleSuffix = searchText ? ` (關鍵字: "${searchText}")` : ''; const title = `AV放送立願報名記錄 (${dateRangeText})${titleSuffix}`; const generateTime = new Date().toLocaleString('zh-TW'); let htmlContent = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>table{border-collapse:collapse;width:100%;font-family:'Microsoft JhengHei',sans-serif}td,th{border:1px solid #ddd;text-align:left;padding:8px}th{background-color:#f2f2f2}.title-row{background-color:#FF8C42;color:white;font-weight:bold;font-size:16px;text-align:center}
/* --- MOBILE DATE INPUT FIX (追加) --- */
@media (max-width: 768px) {
  .inline-form {
    flex-direction: column;
    align-items: center;
  }
  .inline-form > .form-group,
  .inline-form > .btn {
    width: 92vw;
    max-width: 480px;
  }
  .inline-form .form-group > input,
  .inline-form .form-group > select {
    width: 100%;
    box-sizing: border-box;
  }
  .inline-form input[type="date"] {
    -webkit-appearance: none;
    appearance: none;
    min-width: 0;
    max-width: 100%;
  }
}


/* --- HOTFIX: 修正手機超出容器（覆寫前一版 92vw 設定） --- */
@media (max-width: 768px) {
  .inline-form { 
    align-items: stretch !important; 
    width: 100% !important;
  }
  .inline-form > .form-group,
  .inline-form > .btn {
    width: 100% !important;
    max-width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
  }
  .inline-form .form-group > input,
  .inline-form .form-group > select {
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box;
  }
  .inline-form input[type="date"] {
    -webkit-appearance: none;
    appearance: none;
    min-width: 0;
    width: 100% !important;
    max-width: 100% !important;
  }
}

</style></head><body><table><tr><td colspan="5" class="title-row">${title}</td></tr><tr><td colspan="5">報表生成時間：${generateTime}</td></tr><tr><th>活動日期</th><th>活動名稱</th><th>崗位</th><th>報名者</th><th>報名時間</th></tr>`; dataToExport.forEach(row => { htmlContent += `<tr><td>${row.eventDate||''}</td><td>${row.eventTitle||''}</td><td>${row.position||''}</td><td>${row.user||''}</td><td>'${row.timestamp||''}'</td></tr>`; }); htmlContent += '</table></body></html>'; const blob = new Blob([htmlContent], { type: 'application/vnd.ms-excel;charset=utf-8;' }); const fileName = `AV立願報名記錄_${new Date().toISOString().slice(0,10)}.xls`; const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = fileName; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); } catch (e) { Swal.fire('匯出失?', e.message, 'error'); } finally { hideLoading(); } }

        document.addEventListener('DOMContentLoaded', function() {
            const feVerEl = document.getElementById('frontend-version');
            if (feVerEl) feVerEl.textContent = FRONTEND_VERSION;
            window.scrollTo(0, 0); 
            Chart.register(ChartDataLabels); 
            
            let marqueeMessages = [], marqueeIndex = 0;
            const marqueeTextEl = document.getElementById('marquee-text');

            async function setupMarquee() {
                if (!marqueeTextEl) return;
                try {
                    const response = await callAppsScript('getNewsAnnouncements');
                    marqueeMessages = response.data;
                    if (marqueeMessages && marqueeMessages.length > 0) {
                        cycleMarquee();
                        setInterval(cycleMarquee, 5000);
                    } else {
                        marqueeTextEl.textContent = '目前沒有最新公告';
                        marqueeTextEl.style.animation = 'none';
                    }
                } catch (error) {
                    console.error('從後端載入公告失敗:', error);
                    if (marqueeTextEl) {
                        marqueeTextEl.textContent = '無法載入最新公告';
                        marqueeTextEl.style.animation = 'none';
                    }
                }
            }

            function cycleMarquee() {
                if (marqueeMessages.length === 0 || !marqueeTextEl) return;
                const nextMessage = marqueeMessages[marqueeIndex];
                if (isMobile) {
                    marqueeTextEl.style.opacity = 0;
                    setTimeout(() => {
                        marqueeTextEl.textContent = nextMessage;
                        marqueeTextEl.style.opacity = 1;
                    }, 400);
                } else {
                    marqueeTextEl.style.animation = 'none';
                    void marqueeTextEl.offsetWidth;
                    marqueeTextEl.textContent = nextMessage;
                    marqueeTextEl.style.animation = 'marquee-scroll 5s ease-in-out';
                }
                marqueeIndex = (marqueeIndex + 1) % marqueeMessages.length;
            }
            
            setupMarquee();

            function setupMarqueeToggle() {
                const toggleBtn = document.getElementById('toggle-marquee-btn');
                const marqueeContainer = document.getElementById('marquee-container');
                if (!toggleBtn || !marqueeContainer) {
                    return;
                }
                let isVisible = localStorage.getItem('av_marquee_visible') !== 'false';
                const playDogSound = () => {
                    const audioEl = document.getElementById('dog-audio');
                    if (!audioEl) return;
                    marqueeContainer.classList.remove('marquee-bark');
                    void marqueeContainer.offsetWidth; // restart animation
                    marqueeContainer.classList.add('marquee-bark');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    try {
                        audioEl.currentTime = 0;
                        const p = audioEl.play();
                        const duration = audioEl.duration && isFinite(audioEl.duration) ? audioEl.duration * 1000 : 1800;
                        if (p && typeof p.then === 'function') {
                            p.catch(() => {});
                        }
                        return duration;
                    } catch (e) {}
                    return 1800;
                };
                const applyVisibility = () => {
                    if (isVisible) {
                        marqueeContainer.style.display = 'flex';
                        marqueeContainer.style.maxHeight = '200px';
                        marqueeContainer.style.opacity = '1';
                        marqueeContainer.style.marginBottom = '20px';
                    } else {
                        marqueeContainer.style.maxHeight = '0';
                        marqueeContainer.style.opacity = '0';
                        marqueeContainer.style.marginBottom = '0';
                        setTimeout(() => {
                            if (!isVisible) marqueeContainer.style.display = 'none';
                        }, 400);
                    }
                };
                applyVisibility();
                toggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const wasVisible = isVisible;
                    isVisible = !isVisible;
                    localStorage.setItem('av_marquee_visible', isVisible);
                    const animDuration = playDogSound();
                    if (!isVisible && wasVisible) {
                        marqueeContainer.classList.remove('marquee-bark');
                        void marqueeContainer.offsetWidth;
                        marqueeContainer.classList.add('marquee-bark');
                        setTimeout(() => { applyVisibility(); }, animDuration || 1800);
                    } else {
                        applyVisibility();
                    }
                });
            }
            setupMarqueeToggle();

            const getMonthDateRange = () => { const today = new Date(); const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1); const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0); return { firstDayStr: firstDayOfMonth.toLocaleDateString('en-CA'), lastDayStr: lastDayOfMonth.toLocaleDateString('en-CA') }; };
            const { firstDayStr, lastDayStr } = getMonthDateRange();
            ['search-start-date', 'stats-start-date', 'export-start-date', 'performance-start-date'].forEach(id => { const el = document.getElementById(id); if(el) el.value = firstDayStr; });
            ['search-end-date', 'stats-end-date', 'export-end-date', 'performance-end-date'].forEach(id => { const el = document.getElementById(id); if(el) el.value = lastDayStr; });
            
            setupCalendarTab(true); 

            document.getElementById('unified-search-btn').addEventListener('click', () => { const eventSelectValue = document.getElementById('event-select').value; let eventDate = ''; let eventTitle = ''; if (eventSelectValue) { try { const eventData = JSON.parse(eventSelectValue); eventDate = eventData.date; eventTitle = eventData.title; } catch (e) { eventTitle = eventSelectValue; } } const keyword = document.getElementById('universal-search-input').value.trim(); const queryStartDate = document.getElementById('search-start-date').value; const queryEndDate = document.getElementById('search-end-date').value; if (!queryStartDate || !queryEndDate) { return Swal.fire('提示', '請選擇查詢的開始及結束日期。', 'info'); } if (new Date(queryStartDate) > new Date(queryEndDate)) { return Swal.fire('提示', '開始日期不可晚於結束日期。', 'info'); } const searchText = keyword; lastQuery = { type: 'unified', params: { searchText, startDateStr: queryStartDate, endDateStr: queryEndDate, eventDate, eventTitle, keyword }, data: [] }; executeUnifiedSignupQuery(searchText, queryStartDate, queryEndDate, eventDate, eventTitle, keyword); }); 
            document.getElementById('clear-search-btn').addEventListener('click', () => { document.getElementById('event-select').value = ''; document.getElementById('universal-search-input').value = ''; const { firstDayStr, lastDayStr } = getMonthDateRange(); document.getElementById('search-start-date').value = firstDayStr; document.getElementById('search-end-date').value = lastDayStr; document.getElementById('my-signups-result').innerHTML = ''; document.getElementById('query-actions-container').style.display = 'none'; lastQuery = { type: null, params: {}, data: [] }; }); 
            document.getElementById('generate-stats').addEventListener('click', generateStatsReport); 
            document.getElementById('generate-performance-report').addEventListener('click', generatePerformanceReport);
            const resetStatsBtn = document.getElementById('reset-stats-btn');
            if (resetStatsBtn) {
                resetStatsBtn.addEventListener('click', () => {
                    const { firstDayStr, lastDayStr } = getMonthDateRange();
                    document.getElementById('stats-start-date').value = firstDayStr;
                    document.getElementById('stats-end-date').value = lastDayStr;
                    if (statsChart) { statsChart.destroy(); statsChart = null; }
                    const statsCanvas = document.getElementById('stats-chart');
                    if (statsCanvas) statsCanvas.style.display = 'none';
                    lastStatsData = null;
                    const statsDetails = document.getElementById('stats-details-container');
                    if (statsDetails) statsDetails.innerHTML = '';
                });
            }
            const resetPerformanceBtn = document.getElementById('reset-performance-btn');
            if (resetPerformanceBtn) {
                resetPerformanceBtn.addEventListener('click', () => {
                    const { firstDayStr, lastDayStr } = getMonthDateRange();
                    document.getElementById('performance-start-date').value = firstDayStr;
                    document.getElementById('performance-end-date').value = lastDayStr;
                    if (performanceChart) { performanceChart.destroy(); performanceChart = null; }
                    const perfCanvas = document.getElementById('performance-chart');
                    if (perfCanvas) perfCanvas.style.display = 'none';
                    const perfDetails = document.getElementById('performance-details-container');
                    if (perfDetails) perfDetails.innerHTML = '';
                });
            }

            document.getElementById('export-from-query-btn').addEventListener('click', exportCurrentQueryResultToExcel); 
            const shareToClipboardContent = async (functionToCall, params = {}) => {
                showLoading();
                try {
                    const response = await callAppsScript(functionToCall, params);
                    const data = response.data;
                    hideLoading();
                    if (data.status === 'nodata') {
                        Swal.fire('無資料', `您選擇的日期沒有任何報名記錄可供分享。`, 'info');
                        return;
                    }
                    if (data.text) {
                        Swal.fire({
                            title: '&#128203; 準備分享的內容',
                            width: isMobile ? '92vw' : '680px',
                            html: `<div style="width:100%;"><textarea id="clipboard-textarea" readonly style="width:100%;max-width:100%;min-height:220px;padding:12px 14px;border-radius:10px;border:1px solid #d8dee9;box-sizing:border-box;font-size:15px;line-height:1.5;white-space:pre-wrap;">${data.text}</textarea></div>`,
                            confirmButtonText: '&#128203; 複製內容',
                            showCancelButton: true,
                            cancelButtonText: '關閉',
                            didOpen: () => {
                                const textarea = document.getElementById('clipboard-textarea');
                                if (textarea) {
                                    textarea.style.height = 'auto';
                                    textarea.style.height = (textarea.scrollHeight + 5) + 'px';
                                    textarea.select();
                                }
                            },
                            preConfirm: () => {
                                const textToCopy = document.getElementById('clipboard-textarea').value;
                                return navigator.clipboard ? navigator.clipboard.writeText(textToCopy).then(() => true).catch(err => {
                                    Swal.showValidationMessage(`複製失敗: ${err.message}`);
                                    return false;
                                }) : (document.execCommand('copy'), true);
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                Swal.fire({ icon: 'success', title: '已複製成功！', text: '請手動切換到 LINE 或其他應用程式並貼上內容。', timer: 2500, showConfirmButton: false });
                            }
                        });
                    } else {
                        throw new Error("無法從後端取得分享內容。");
                    }
                } catch (e) {
                    hideLoading();
                    Swal.fire('操作失敗', e.message, 'error');
                }
            };
            document.getElementById('share-to-clipboard-btn').addEventListener('click', async () => {
                const { isConfirmed, isDenied, dismiss } = await Swal.fire({
                    title: '選擇要分享的日期',
                    text: '您要分享今天、明天還是指定日期區間的報名資料？',
                    showDenyButton: true, showCancelButton: true, showCloseButton: true,
                    confirmButtonText: '今天', denyButtonText: '明天', cancelButtonText: '按日期',
                    icon: 'question', customClass: { cancelButton: 'swal2-styled swal2-default-outline' }, buttonsStyling: true
                });

                if (isConfirmed) { shareToClipboardContent('getSignupsAsTextForToday'); } 
                else if (isDenied) { shareToClipboardContent('getSignupsAsTextForTomorrow'); } 
                else if (dismiss === Swal.DismissReason.cancel) {
                    const startDateAdmin = document.getElementById('export-start-date').value;
                    const endDateAdmin = document.getElementById('export-end-date').value;
                    if (!startDateAdmin || !endDateAdmin) { return Swal.fire('提示', '請在上方「開始日期」和「結束日期」輸入框中選擇日期區間。', 'info'); }
                    if (new Date(startDateAdmin) > new Date(endDateAdmin)) { return Swal.fire('提示', '開始日期不能晚於結束日期。', 'info'); }
                    shareToClipboardContent('getSignupsAsTextForDateRange', { startDateStr: startDateAdmin, endDateStr: endDateAdmin });
                }
            });
            document.getElementById('admin-reset-btn').addEventListener('click', () => {
                const { firstDayStr, lastDayStr } = getMonthDateRange();
                const startEl = document.getElementById('export-start-date');
                const endEl = document.getElementById('export-end-date');
                if (startEl) startEl.value = firstDayStr;
                if (endEl) endEl.value = lastDayStr;
            });

            // --- LINE 通知設定按鈕事件 ---
            document.getElementById('setup-line-trigger-btn').addEventListener('click', async () => {
                console.log('[DEBUG] "啟動每日通知" 按鈕點擊。');
                const { value: password, isConfirmed } = await Swal.fire({
                    title: '啟動每日通知',
                    html: `
                        <p>這將會在後端設定一個「每天晚上 8 點」自動執行的排程。</p>
                        <p style="margin-top: 1em;">請輸入管理密碼以確認：</p>
                        <input type="password" id="swal-password" class="swal2-input" placeholder="請輸入密碼">
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: '確定啟動',
                    cancelButtonText: '取消',
                    focusConfirm: false,
                    preConfirm: () => {
                        const pw = document.getElementById('swal-password').value;
                        if (pw !== '590314') {
                            Swal.showValidationMessage('密碼錯誤！');
                            return false;
                        }
                        return pw;
                    }
                });

                console.log(`[DEBUG] 密碼彈窗結果: isConfirmed=${isConfirmed}, password=${password ? '***' : null}`);
                if (!isConfirmed || !password) {
                    console.log('[DEBUG] 操作取消或密碼錯誤，提前返回。');
                    return;
                }

                console.log('[DEBUG] 準備呼叫後端函式: setupDailyTrigger');
                showLoading();
                try {
                    const response = await callAppsScript('setupDailyTrigger');
                    console.log('[DEBUG] 後端 callAppsScript("setupDailyTrigger") 回應:', response);
                    if (response.data && response.data.status === 'success') {
                        Swal.fire('設定成功', '每日 20:00 的自動通知排程已建立。', 'success');
                    } else {
                        const errorMessage = (response.data && response.data.error) ? response.data.error : (response.message || '未知錯誤');
                        console.error('[DEBUG] 後端回傳失敗:', errorMessage, response);
                        throw new Error(errorMessage);
                    }
                } catch (e) { console.error('[DEBUG] callAppsScript("setupDailyTrigger") 捕捉到錯誤:', e); Swal.fire('設定失敗', e.message, 'error'); } finally { hideLoading(); }
            });

            document.getElementById('test-line-notify-btn').addEventListener('click', async () => {
                console.log('[DEBUG] "立即測試發送" 按鈕點擊。');
                const { value: password, isConfirmed } = await Swal.fire({
                    title: '立即測試發送',
                    html: `
                        <p>這將會立即發送明天的立願名單至 LINE。</p>
                        <p style="margin-top: 1em;">請輸入管理密碼以確認：</p>
                        <input type="password" id="swal-password" class="swal2-input" placeholder="請輸入密碼">
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: '確認發送',
                    cancelButtonText: '取消',
                    focusConfirm: false,
                    preConfirm: () => {
                        const pw = document.getElementById('swal-password').value;
                        if (pw !== '590314') {
                            Swal.showValidationMessage('密碼錯誤！');
                            return false;
                        }
                        return pw;
                    }
                });

                console.log(`[DEBUG] 密碼彈窗結果: isConfirmed=${isConfirmed}, password=${password ? '***' : null}`);
                if (!isConfirmed || !password) {
                    console.log('[DEBUG] 操作取消或密碼錯誤，提前返回。');
                    return;
                }
                
                console.log('[DEBUG] 準備呼叫後端函式: manualTriggerDailyNotify');
                showLoading();
                try {
                    const response = await callAppsScript('manualTriggerDailyNotify');
                    console.log('[DEBUG] 後端 callAppsScript("manualTriggerDailyNotify") 回應:', response);
                    if (response.data && response.data.status === 'success') {
                        Swal.fire('發送成功', '測試訊息已發送，請檢查 LINE。', 'success');
                    } else {
                        const errorMessage = (response.data && response.data.error) ? response.data.error : (response.message || '發送失敗');
                        console.error('[DEBUG] 後端回傳失敗:', errorMessage, response);
                        throw new Error(errorMessage);
                    }
                } catch (e) { console.error('[DEBUG] callAppsScript("manualTriggerDailyNotify") 捕捉到錯誤:', e); Swal.fire('測試失敗', e.message, 'error'); } finally { hideLoading(); }
            });

            document.getElementById('share-query-to-clipboard-btn').addEventListener('click', () => { if (!lastQuery || !lastQuery.data || lastQuery.data.length === 0) { return Swal.fire('無資料', '沒有可分享的查詢結果。', 'info'); } const { searchText, startDateStr, endDateStr } = lastQuery.params; const titleKeyword = searchText ? `，關鍵字：「${searchText}」` : ''; const title = `【AV放送立願報名查詢結果】\n日期：${startDateStr} ~ ${endDateStr}${titleKeyword}\n----------\n`; const eventsGroup = {}; lastQuery.data.forEach(signup => { const key = `${signup.eventDate} ${signup.eventTitle}`; if (!eventsGroup[key]) { eventsGroup[key] = []; } eventsGroup[key].push(`- ${signup.position}: ${signup.user}`); }); let shareText = title; Object.keys(eventsGroup).sort().forEach(eventKey => { shareText += `\n【${eventKey}】\n`; shareText += eventsGroup[eventKey].join('\n'); shareText += '\n'; }); shareText += '\n查看最新報名資訊：\nhttps://angewoo.github.io/AVschedule/'; Swal.fire({ title: '&#128203; 準備分享的內容', width: isMobile ? '92vw' : '680px', html: `<div style="width:100%;"><textarea id="clipboard-textarea" readonly style="width:100%;max-width:100%;min-height:220px;padding:12px 14px;border-radius:10px;border:1px solid #d8dee9;box-sizing:border-box;font-size:15px;line-height:1.5;white-space:pre-wrap;">${shareText}</textarea></div>`, confirmButtonText: '&#128203; 複製內容', showCancelButton: true, cancelButtonText: '關閉', didOpen: () => { const textarea = document.getElementById('clipboard-textarea'); if (textarea) { textarea.style.height = 'auto'; textarea.style.height = (textarea.scrollHeight + 5) + 'px'; textarea.select(); } }, preConfirm: () => { const textToCopy = document.getElementById('clipboard-textarea').value; return navigator.clipboard ? navigator.clipboard.writeText(textToCopy).then(() => true).catch(err => { Swal.showValidationMessage(`複製失敗: ${err.message}`); return false; }) : (document.execCommand('copy'), true); } }).then((result) => { if (result.isConfirmed) { Swal.fire({ icon: 'success', title: '已複製成功！', text: '請手動切換到 LINE 或其他應用程式並貼上內容。', timer: 2500, showConfirmButton: false }); } }); });

            const topFab = document.getElementById('scroll-top-btn');
            const bottomFab = document.getElementById('scroll-bottom-btn');
            const updateFabVisibility = () => {
                const scrollTop = window.scrollY || document.documentElement.scrollTop;
                const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
                const docHeight = document.documentElement.scrollHeight;
                if (topFab) topFab.classList.toggle('hidden', scrollTop < 120);
                if (bottomFab) bottomFab.classList.toggle('hidden', scrollTop + viewportHeight > docHeight - 120);
            };
            if (topFab && bottomFab) {
                topFab.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
                bottomFab.addEventListener('click', () => window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' }));
                window.addEventListener('scroll', updateFabVisibility, { passive: true });
                updateFabVisibility();
            }
            const savedTab = localStorage.getItem('av_active_tab') || 'calendar-tab';
            const tabBtn = document.querySelector(`.tab-button[onclick*="'${savedTab}'"]`);
            if (tabBtn) tabBtn.click();
            const handleDocDownload = (docType) => {
                const docMap = {
                    poster: { action: 'open', url: '01.pdf', filename: 'AV招生海報.pdf' },
                    manualNight: { action: 'open', url: '02.pdf', filename: '一如祈念次第(晚上).pdf' },
                    manualDay: { action: 'open', url: '03.pdf', filename: '一如祈念次第(白天).pdf' },
                    bulletin: { action: 'open', url: '放送奉侍佈告.pdf', filename: '放送奉侍佈告.pdf' },
                    liveStreamGuide: { action: 'open', url: '直播開啟及關閉方式.pdf', filename: '直播開啟及關閉方式.pdf' },
                    computer: { action: 'open', url: 'https://docs.google.com/presentation/d/1dtRM_tI9JlBvQxQTzfaYWuUNh206BC88/edit?usp=sharing&ouid=116073418031278322428&rtpof=true&sd=true', filename: '電腦操作手冊.pptx' },
                    lighting: { action: 'open', url: 'https://docs.google.com/presentation/d/16NICJPmTTz-UyrxN44hpAvV0yI2WEFYb/edit?usp=drive_link&ouid=116073418031278322428&rtpof=true&sd=true', filename: '燈光操作手冊.pptx' },
                    audio: { action: 'open', url: 'https://docs.google.com/presentation/d/1rCb7AVwQWWtkwaq0pfo87YcgcCwbEpua/edit?usp=sharing&ouid=116073418031278322428&rtpof=true&sd=true', filename: '音控操作手冊.pptx' },
                    camera: { action: 'open', url: 'https://docs.google.com/presentation/d/1zZ-9Z7QvP-I-R4NtLSFNFOHArsRsjhyZ/edit?usp=sharing&ouid=116073418031278322428&rtpof=true&sd=true', filename: '攝影操作手冊.pptx' },
                    videoSignupSOP: { action: 'open', url: 'https://www.youtube.com/shorts/hBQ18yN0PKs', filename: '立願報名SOP.mp4' },
                    videoDeleteSOP: { action: 'open', url: 'https://www.youtube.com/shorts/SUrClrkf6e0', filename: '立願刪除SOP.mp4' },
                    videoQuerySOP: { action: 'open', url: 'https://www.youtube.com/shorts/1oE9SEIzeX4', filename: '立願查詢SOP.mp4' },
                    videoCableWrap: { action: 'open', url: 'https://v.pinimg.com/videos/mc/720p/1b/37/10/1b37107c72f5d947f6d8376e1074e0d9.mp4', filename: '攝影師收線示範.mp4' }
                };
                const doc = docMap[docType];
                if (!doc || !doc.url || doc.url === '#') { return Swal.fire({ icon: 'warning', title: '功能尚未啟用', text: `此文件 (${doc ? doc.filename : '未知'}) 的連結尚未設定。`, confirmButtonColor: 'var(--primary-color)' }); }
                if (doc.action === 'open') { window.open(doc.url, '_blank'); } 
                else { const link = document.createElement('a'); link.href = doc.url; link.download = doc.filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
            };
            document.getElementById('download-poster').addEventListener('click', () => handleDocDownload('poster'));
            document.getElementById('download-manual-night').addEventListener('click', () => handleDocDownload('manualNight'));
            document.getElementById('download-manual-day').addEventListener('click', () => handleDocDownload('manualDay'));
            document.getElementById('download-bulletin').addEventListener('click', () => handleDocDownload('bulletin'));
            document.getElementById('download-live-stream-guide').addEventListener('click', () => handleDocDownload('liveStreamGuide'));
            document.getElementById('download-doc-computer').addEventListener('click', () => handleDocDownload('computer'));
            document.getElementById('download-doc-lighting').addEventListener('click', () => handleDocDownload('lighting'));
            document.getElementById('download-doc-audio').addEventListener('click', () => handleDocDownload('audio'));
            document.getElementById('download-doc-camera').addEventListener('click', () => handleDocDownload('camera'));
            document.getElementById('download-video-signup-sop').addEventListener('click', () => handleDocDownload('videoSignupSOP'));
            document.getElementById('download-video-delete-sop').addEventListener('click', () => handleDocDownload('videoDeleteSOP'));
            document.getElementById('download-video-query-sop').addEventListener('click', () => handleDocDownload('videoQuerySOP'));
            document.getElementById('download-video-cable-wrap').addEventListener('click', () => handleDocDownload('videoCableWrap'));
        });
    </script>
</body>
</html>
